<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="http://sequenceiq.com/cloudbreak-docs/aws/">
        <link rel="shortcut icon" href="../img/favicon.ico">

	<title>AWS - Cloudbreak 1.2.3</title>

        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation" background="red">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <img class="navbar-logo" src="../img/HWX-RGB-full-no-tagline_500pxh.png" alt="Hortonworks Documentation"
                 width="132" height="52">
            <a class="navbar-brand" href="..">Cloudbreak 1.2.3</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Home <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="..">Introduction</a>
</li>

                        
                            
<li >
    <a href="../architecture/">Architecture</a>
</li>

                        
                            
<li >
    <a href="../onprem/">Installation</a>
</li>

                        
                            
<li >
    <a href="../releasenotes/">Release Notes</a>
</li>

                        
                            
<li >
    <a href="../changelog/">Change Log</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="active">
                        <a href="./">AWS</a>
                    </li>
                
                
                
                    <li >
                        <a href="../azure/">Azure</a>
                    </li>
                
                
                
                    <li >
                        <a href="../gcp/">GCP</a>
                    </li>
                
                
                
                    <li >
                        <a href="../openstack/">OpenStack</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Reference <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../api/">API</a>
</li>

                        
                            
<li >
    <a href="../shell/">CLI/Shell</a>
</li>

                        
                            
<li >
    <a href="../ui_account/">Account Management</a>
</li>

                        
                            
<li >
    <a href="../periscope/">Auto-Scaling</a>
</li>

                        
                            
<li >
    <a href="../sssd/">SSSD Configuration</a>
</li>

                        
                            
<li >
    <a href="../recipes/">Recipes</a>
</li>

                        
                            
<li >
    <a href="../blueprints/">Blueprints</a>
</li>

                        
                            
<li >
    <a href="../topologies/">Platforms</a>
</li>

                        
                            
<li >
    <a href="../kerberos/">Kerberos</a>
</li>

                        
                            
<li >
    <a href="../mesos/">Mesos</a>
</li>

                        
                            
<li >
    <a href="../spi/">SPI</a>
</li>

                        
                            
<li >
    <a href="../operations/">Operations</a>
</li>

                        
                            
<li >
    <a href="../database/">Migration</a>
</li>

                        
                            
<li >
    <a href="../configuration/">Advanced Configuration</a>
</li>

                        
                            
<li >
    <a href="../development/">Development</a>
</li>

                        
                            
<li >
    <a href="../issues/">Known issues</a>
</li>

                        
                        </ul>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Versions <b class="caret"></b></a>
                    <ul class="dropdown-menu" id="versions-dropdown">
                    </ul>
                </li>
                
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li >
                        <a rel="next" href="../changelog/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../azure/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
                    <li>
                        <a href="https://github.com/sequenceiq/cloudbreak-docs/blob/master/docs/" >
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#aws-images">AWS Images</a></li>
        
            <li><a href="#cloudbreak-deployer-aws-image-details">Cloudbreak Deployer AWS Image Details</a></li>
        
    
        <li class="main "><a href="#aws-setup">AWS Setup</a></li>
        
            <li><a href="#setup-cloudbreak-deployer">Setup Cloudbreak Deployer</a></li>
        
            <li><a href="#start-cloudbreak-deployer">Start Cloudbreak Deployer</a></li>
        
            <li><a href="#validate-the-started-cloudbreak-deployer">Validate the started Cloudbreak Deployer</a></li>
        
    
        <li class="main "><a href="#provisioning-prerequisites">Provisioning Prerequisites</a></li>
        
            <li><a href="#iam-role-setup">IAM role setup</a></li>
        
            <li><a href="#generate-a-new-ssh-key">Generate a new SSH key</a></li>
        
    
        <li class="main "><a href="#provisioning-via-browser">Provisioning via Browser</a></li>
        
            <li><a href="#setting-up-aws-credentials">Setting up AWS credentials</a></li>
        
            <li><a href="#infrastructure-templates">Infrastructure templates</a></li>
        
            <li><a href="#defining-cluster-services">Defining cluster services</a></li>
        
            <li><a href="#cluster-deployment">Cluster deployment</a></li>
        
            <li><a href="#cluster-termination">Cluster termination</a></li>
        
    
        <li class="main "><a href="#interactive-mode-cloudbreak-shell">Interactive mode / Cloudbreak Shell</a></li>
        
            <li><a href="#start-cloudbreak-shell">Start Cloudbreak Shell</a></li>
        
            <li><a href="#autocomplete-and-hints">Autocomplete and hints</a></li>
        
    
        <li class="main "><a href="#provisioning-via-cli">Provisioning via CLI</a></li>
        
            <li><a href="#setting-up-aws-credential">Setting up AWS credential</a></li>
        
            <li><a href="#infrastructure-templates_1">Infrastructure templates</a></li>
        
            <li><a href="#defining-cluster-services_1">Defining cluster services</a></li>
        
            <li><a href="#metadata-show">Metadata show</a></li>
        
            <li><a href="#cluster-deployment_1">Cluster deployment</a></li>
        
            <li><a href="#cluster-termination_1">Cluster termination</a></li>
        
            <li><a href="#silent-mode">Silent mode</a></li>
        
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">
                    

<h1 id="aws-images">AWS Images</h1>
<p>We have pre-built cloud images for AWS with the Cloudbreak Deployer pre-installed. You can launch the latest 
Cloudbreak Deployer image based on your region at the <a href="https://aws.amazon.com/console/">AWS Management Console</a>.</p>
<blockquote>
<p>Alternatively, instead of using the pre-built cloud images for AWS, you can install Cloudbreak Deployer on your own
 VM. See <a href="../onprem/">installation page</a> for more information.</p>
</blockquote>
<p>Please make sure you opened the following ports on your <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-network-security.html">security group</a>:</p>
<ul>
<li>SSH (22)</li>
<li>Cloudbreak API (8080)</li>
<li>Identity server (8089)</li>
<li>Cloudbreak GUI (3000)</li>
<li>User authentication (3001)</li>
</ul>
<h2 id="cloudbreak-deployer-aws-image-details">Cloudbreak Deployer AWS Image Details</h2>
<blockquote>
<p><strong><a href="../onprem/#minimum-and-recommended-system-requirements">Minimum and Recommended VM requirements</a>:</strong> 8GB RAM, 10GB disk, 2 cores (The minimum instance type which is fit for cloudbreak is <strong>m3.large</strong>)</p>
</blockquote>
<h1 id="aws-setup">AWS Setup</h1>
<p><strong>Cloudbreak Deployer Highlights</strong></p>
<ul>
<li>The default SSH username for the EC2 instances is <code>cloudbreak</code>.</li>
<li>Cloudbreak Deployer location is <code>/var/lib/cloudbreak-deployment</code> on the launched EC2 instance. This is the
  <code>cbd</code> root folder there.</li>
<li>All <code>cbd</code> actions must be executed from the <code>cbd</code> root folder as <code>cloudbreak</code> user.</li>
</ul>
<h2 id="setup-cloudbreak-deployer">Setup Cloudbreak Deployer</h2>
<p>You should already have the Cloudbreak Deployer either by <a href="./">using the AWS Cloud Images</a> or by <a href="../onprem/">installing the
Cloudbreak Deployer</a> manually on your own VM.</p>
<p>If you have your own installed VM, you should check the <a href="./#initialize-your-profile">Initialize your Profile</a>
section here before starting the provisioning.</p>
<p>You can <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AccessingInstances.html">connect to the previously created <code>cbd</code> VM</a>.</p>
<p>To open the <code>cloudbreak-deployment</code> directory:</p>
<pre><code>cd /var/lib/cloudbreak-deployment/
</code></pre>

<p>This is the directory of the configuration files and the supporting binaries for Cloudbreak Deployer.</p>
<h3 id="initialize-your-profile">Initialize your Profile</h3>
<p>First initialize <code>cbd</code> by creating a <code>Profile</code> file:</p>
<pre><code>cbd init
</code></pre>

<p>It will create a <code>Profile</code> file in the current directory. Please open the <code>Profile</code> file then check the <code>PUBLIC_IP</code>.
This is mandatory, because of to can access the Cloudbreak UI (called Uluwatu). In some cases the <code>cbd</code> tool tries to
guess it. If <code>cbd</code> cannot get the IP address during the initialization, please set the appropriate value.</p>
<h3 id="aws-specific-configuration">AWS specific configuration</h3>
<p><strong>AWS Account Keys</strong></p>
<p>There are 2 ways to create AWS credentials in Cloudbreak.</p>
<ul>
<li>Key-based: It requires your AWS access and secret key and Cloudbreak will use this key to launch the resources. This key needs to be provided when you create your credential in Cloudbreak either with Cloudbreak UI or Cloudbreak CLI.</li>
<li>Role-based: It requires a valid IAM User role and Cloudbreak will assume this role to get a temporary access and secret key. For this action you need to set your AWS key in the <code>Profile</code> file.
We suggest to use the keys of a valid <strong>IAM User</strong> here.</li>
</ul>
<pre><code>export AWS_ACCESS_KEY_ID=AKIA**************W7SA
export AWS_SECRET_ACCESS_KEY=RWCT4Cs8******************/*skiOkWD
</code></pre>

<blockquote>
<p>If you'd like to use instance profiles then these variables should not be configured. Please be sure that the instance profile role can assume roles on AWS if you want to provision your clusters with Role ARN's and not with AWS access and secret keys.</p>
</blockquote>
<h2 id="start-cloudbreak-deployer">Start Cloudbreak Deployer</h2>
<p>To start the Cloudbreak application use the following command.
This will start all the Docker containers and initialize the application.</p>
<pre><code>cbd start
</code></pre>

<blockquote>
<p>At the very first time it will take for a while, because of need to download all the necessary docker images.</p>
</blockquote>
<p>The <code>cbd start</code> command includes the <code>cbd generate</code> command which applies the following steps:</p>
<ul>
<li>creates the <strong>docker-compose.yml</strong> file that describes the configuration of all the Docker containers needed for the Cloudbreak deployment.</li>
<li>creates the <strong>uaa.yml</strong> file that holds the configuration of the identity server which is used to authenticate users to Cloudbreak.</li>
</ul>
<h2 id="validate-the-started-cloudbreak-deployer">Validate the started Cloudbreak Deployer</h2>
<p>After the <code>cbd start</code> command finishes followings are worthy to check:</p>
<ul>
<li>Pre-installed Cloudbreak Deployer version and health:</li>
</ul>
<pre><code>   cbd doctor
</code></pre>

<blockquote>
<p>In case of <code>cbd update</code> is needed, please check the related documentation for <a href="../operations/#update-cloudbreak-deployer">Cloudbreak Deployer Update</a>.</p>
</blockquote>
<ul>
<li>Started Cloudbreak Application logs:</li>
</ul>
<pre><code>   cbd logs cloudbreak
</code></pre>

<blockquote>
<p>Cloudbreak should start within a minute - you should see a line like this: <code>Started CloudbreakApplication in 36.823 seconds</code></p>
</blockquote>
<h1 id="provisioning-prerequisites">Provisioning Prerequisites</h1>
<h2 id="iam-role-setup">IAM role setup</h2>
<blockquote>
<p>If you want to use your Aws Access Key and your Secret Access Key to authenticate to Amazon then please use the <code>Key based authentication</code> and you do not need to setup an IAM Role.</p>
</blockquote>
<p>Cloudbreak works by connecting your AWS account through so called <em>Credentials</em>, and then uses these credentials to 
create resources on your behalf.</p>
<blockquote>
<p><strong>IMPORTANT</strong> Cloudbreak deployment uses two different AWS accounts for two different purposes:</p>
</blockquote>
<ul>
<li>The account belonging to the <em>Cloudbreak webapp</em> itself, acts as a <em>third party</em>, that creates resources on the 
account of the <em>end user</em>. This account is configured at server-deployment time.</li>
<li>The account belonging to the <em>end user</em> who uses the UI or the Shell to create clusters. This account is configured
 when setting up credentials.</li>
</ul>
<p>These accounts are usually <em>the same</em> when the end user is the same who deployed the Cloudbreak server, but it allows
 Cloudbreak to act as a SaaS project as well if needed.</p>
<p>Credentials use <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html">IAM Roles</a> to give access to the 
third party to act on behalf of the end user without giving full access to your resources.
This IAM Role will be <em>assumed</em> later by an IAM user.</p>
<p><strong>AWS IAM Policy that grants permission to assume a role</strong></p>
<p><strong>You cannot assume a role with root account</strong>, so you need to <strong>create an IAM user</strong> with an attached <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_managed-vs-inline.html"><em>Inline</em> 
policy</a> and <strong>then set the 
Access key and Secret Access key</strong> in the 
<code>Profile</code> file (check <a href="./#aws-specific-configuration">this description</a> out).</p>
<p>The <code>sts-assume-role</code> IAM user <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_temp_control-access_enable-create.html">policy</a> must be configured to have 
permission to assume roles on all resources. Here it is the policy to configure the <code>sts:AssumeRole</code> for all 
<code>Resource</code>:</p>
<pre><code>{
  &quot;Version&quot;: &quot;2012-10-17&quot;,
  &quot;Statement&quot;: [
    {
      &quot;Sid&quot;: &quot;Stmt1400068149000&quot;,
      &quot;Effect&quot;: &quot;Allow&quot;,
      &quot;Action&quot;: [
        &quot;sts:AssumeRole&quot;
      ],
      &quot;Resource&quot;: [
        &quot;*&quot;
      ]
    }
  ]
}
</code></pre>

<p>To connect your (<em>end user</em>) AWS account with a credential in Cloudbreak you'll have to create an IAM role on your 
AWS account that is configured to allow the third-party account to access and create resources on your behalf.
The easiest way to do this is with <code>cbd</code> commands (but it can also be done manually from the <a href="https://console.aws.amazon.com">AWS Console</a>):</p>
<pre><code>cbd aws generate-role  - Generates an AWS IAM role for Cloudbreak provisioning on AWS
cbd aws show-role      - Show assumers and policies for an AWS role
cbd aws delete-role    - Deletes an AWS IAM role, removes all inline policies
</code></pre>

<p>The <code>generate-role</code> command creates a role that is assumable by the Cloudbreak Deployer AWS account and has a broad policy setup.
This command creates a role with the name <code>cbreak-deployer</code> by default. If you'd like to create role with a different
 name or multiple roles, you need to add this line to your <code>Profile</code>:</p>
<pre><code>export AWS_ROLE_NAME=my-cloudbreak-role
</code></pre>

<p>You can check the generated role on your AWS console, under IAM roles:
<img alt="" src="../aws/images/aws-iam-role_v2.png" />
<sub><em>Full size <a href="../aws/images/aws-iam-role_v2.png">here</a>.</em></sub></p>
<h2 id="generate-a-new-ssh-key">Generate a new SSH key</h2>
<p>All the instances created by Cloudbreak are configured to allow key-based SSH,
so you'll need to provide an SSH public key that can be used later to SSH onto the instances in the clusters you'll create with Cloudbreak.
You can use one of your existing keys or you can generate a new one.</p>
<p>To generate a new SSH keypair:</p>
<pre><code>ssh-keygen -t rsa -b 4096 -C &quot;your_email@example.com&quot;
# Creates a new ssh key, using the provided email as a label
# Generating public/private rsa key pair.
</code></pre>

<pre><code># Enter file in which to save the key (/Users/you/.ssh/id_rsa): [Press enter]
You'll be asked to enter a passphrase, but you can leave it empty.

# Enter passphrase (empty for no passphrase): [Type a passphrase]
# Enter same passphrase again: [Type passphrase again]
</code></pre>

<p>After you enter a passphrase the keypair is generated. The output should look something like below.</p>
<pre><code># Your identification has been saved in /Users/you/.ssh/id_rsa.
# Your public key has been saved in /Users/you/.ssh/id_rsa.pub.
# The key fingerprint is:
# 01:0f:f4:3b:ca:85:sd:17:sd:7d:sd:68:9d:sd:a2:sd your_email@example.com
</code></pre>

<p>Later you'll need to pass the <code>.pub</code> file's contents to Cloudbreak and use the private part to SSH to the instances</p>
<h1 id="provisioning-via-browser">Provisioning via Browser</h1>
<p>You can log into the Cloudbreak application at <code>http://&lt;Public_IP&gt;:3000/</code>.</p>
<p>The main goal of the Cloudbreak UI is to easily create clusters on your own cloud provider account.
This description details the AWS setup - if you'd like to use a different cloud provider check out its manual.</p>
<p>This document explains the four steps that need to be followed to create Cloudbreak clusters from the UI:</p>
<ul>
<li>connect your AWS account with Cloudbreak</li>
<li>create some template resources on the UI that describe the infrastructure of your clusters</li>
<li>create a blueprint that describes the HDP services in your clusters and add some recipes for customization</li>
<li>launch the cluster itself based on these resources</li>
</ul>
<blockquote>
<p><strong>IMPORTANT</strong> Make sure that you have sufficient qouta (CPU, network, etc) for the requested cluster size</p>
</blockquote>
<h2 id="setting-up-aws-credentials">Setting up AWS credentials</h2>
<p>Cloudbreak works by connecting your AWS account through so called <em>Credentials</em>, and then uses these credentials to 
create resources on your behalf. The credentials can be configured on the <strong>manage credentials</strong> panel on the 
Cloudbreak Dashboard.</p>
<p>To create a new AWS credential follow these steps:</p>
<ol>
<li>Select the credential type. For instance, select the <code>Role Based</code></li>
<li>Fill out the new credential <code>Name</code><ul>
<li>Only alphanumeric and lowercase characters (min 5, max 100 characters) can be applied</li>
</ul>
</li>
<li>Copy your AWS IAM role's Amazon Resource Name (ARN) to the <code>IAM Role ARN</code> field</li>
<li>Copy your SSH public key to the <code>SSH public key</code> field<ul>
<li>The SSH public key must be in OpenSSH format and it's private keypair can be used later to <a href="../operations/#ssh-to-the-hosts">SSH onto every 
instance</a> of every cluster you'll create with this credential.</li>
<li>The <strong>SSH username</strong> for the EC2 instances is <strong>cloudbreak</strong>.</li>
</ul>
</li>
</ol>
<blockquote>
<p>Any other parameter is optional here.</p>
<p><code>Public in account</code> means that all the users belonging to your account will be able to use this credential to create 
clusters, but cannot delete it.</p>
</blockquote>
<p><img alt="" src="../aws/images/aws-credential_v3.png" />
<sub><em>Full size <a href="../aws/images/aws-credential_v3.png">here</a>.</em></sub></p>
<h2 id="infrastructure-templates">Infrastructure templates</h2>
<p>After your AWS account is linked to Cloudbreak you can start creating resource templates that describe your clusters' infrastructure:</p>
<ul>
<li>templates</li>
<li>networks</li>
<li>security groups</li>
</ul>
<p>When you create one of the above resource, <strong>Cloudbreak does not make any requests to AWS. Resources are only created
 on AWS after the <code>create cluster</code> button has pushed.</strong> These templates are saved to Cloudbreak's database and can be 
 reused with multiple clusters to describe the infrastructure.</p>
<p><strong>Templates</strong></p>
<p>Templates describe the <strong>instances of your cluster</strong> - the instance type and the attached volumes. A typical setup is
 to combine multiple templates in a cluster for the different types of nodes. For example you may want to attach multiple
 large disks to the datanodes or have memory optimized instances for Spark nodes.</p>
<p>The instance templates can be configured on the <strong>manage templates</strong> panel on the Cloudbreak Dashboard.</p>
<p>There are some optional configurations here as well:</p>
<ul>
<li><code>Spot price (USD)</code> If specified Cloudbreak will request spot price instances (which might take a while or never be 
fulfilled by Amazon). <strong>This option is <em>not supported</em> by the default RedHat images</strong>.</li>
<li><code>EBS encryption</code> is supported for all volume types. If this option is checked then all the attached disks <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EBSEncryption.html">will be encrypted</a> by Amazon using the AWS KMS master keys.</li>
<li>If <code>Public in account</code> is checked all the users belonging to your account will be able to use this resource to create clusters, but cannot delete it.</li>
</ul>
<p><strong>Networks</strong></p>
<p>Your clusters can be created in their own <strong>Virtual Private Cloud (VPC)</strong> or in one of your already existing VPCs.
If you choose an existing VPC it is possible to create a new subnet within the VPC or use an already existing one.
The subnet's IP range must be defined in the <code>Subnet (CIDR)</code> field using the general CIDR notation.</p>
<p><em>Default AWS Network</em></p>
<p>If you don't want to create or use your custom VPC, you can use the <code>default-aws-network</code> for all your
Cloudbreak clusters. It will create a new VPC with a <code>10.0.0.0/16</code> subnet every time a cluster is created.</p>
<p><em>Custom AWS Network</em></p>
<p>If you'd like to deploy a cluster to a custom VPC you'll have to <strong>create a new network</strong> template on the <strong>manage
networks</strong> panel.</p>
<p>You have the following options:</p>
<ul>
<li><strong>Create a new VPC and a new subnet</strong>: Every time a cluster is created with this kind of network setup a new VPC and a new subnet with the specified IP range will be created for the instances on AWS.</li>
<li><strong>Create a new subnet in an existing VPC</strong>:  Use this kind of network setup if you already have a VPC on AWS where you'd like to put the Cloudbreak created cluster but you'd like to have a separate subnet for it. This setup is only supported for basic VPCs, where an Internet Gateway is configured and instances can have public IP addresses to access the Internet. If you have a specific VPC setup (VGW, NAT, private subnets, etc..) then only the third option can be used.</li>
<li><strong>Use an existing subnet in an existing VPC</strong>:  Use this kind of network setup if you have an existing VPC with one or more subnets on AWS and you'd like to start the instances of a cluster in one of those subnets. Use this setup if you have a specific VPC setup: you should first create the subnet(s) where you'd like to install your clusters directly through AWS and provide their IDs here. In this case there are only 2 requirements for the subnets:</li>
<li>instances in the subnet should be able to reach the Internet to download yum packages (it can be done through a Virtual Gateway, a NAT instance, an Internet Gateway or any other setup)</li>
<li>the VM where Cloudbreak is deployed must be able to reach the instances in the cluster on port 443. (It’s in the same subnet, or through a router from another subnet)</li>
<li><strong>NOTE</strong>: instances in the subnet doesn't need to have public IP addresses in this case</li>
</ul>
<p>You can configure the <code>Subnet Identifier</code> and the <code>Internet Gateway Identifier</code> (IGW) of your VPC.</p>
<blockquote>
<p><strong>IMPORTANT</strong> The subnet CIDR cannot overlap each other in a VPC. So you have to create different network
templates for every each clusters.</p>
</blockquote>
<p>To create a new subnet within the VPC, provide the ID of the subnet which is in the existing VPC and your cluster
will be launched into that subnet. <strong>For example</strong> you can create 3 different clusters with 3 different network
templates for multiple subnets <code>10.0.0.0/24</code>, <code>10.0.1.0/24</code>, <code>10.0.2.0/24</code> with the same VPC and IGW identifiers.</p>
<blockquote>
<p><strong>IMPORTANT</strong> Please make sure the define subnet here doesn't overlap with any of your already deployed subnet in
the VPC, because of the validation only happens after the cluster creation starts.</p>
<p>In case of existing subnet make sure you have enough room within your network space for the new instances.</p>
</blockquote>
<p>If <code>Public in account</code> is checked all the users belonging to your account will be able to use this network template
to create clusters, but cannot delete it.</p>
<blockquote>
<p><strong>NOTE</strong> The VPCs, IGWs and subnet are created on AWS only after the the cluster provisioning starts with the selected
network template.</p>
</blockquote>
<p><img alt="" src="../aws/images/aws-network_v4.png" />
<sub><em>Full size <a href="../aws/images/aws-network_v4.png">here</a>.</em></sub></p>
<p><strong>Security groups</strong></p>
<p>Security group templates are very similar to the <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-network-security.html">security groups on the AWS Console</a>.
<strong>They describe the allowed inbound traffic to the instances in the cluster.</strong>
Currently only one security group template can be selected for a Cloudbreak cluster and all the instances have a 
public IP address so all the instances in the cluster will belong to the same security group.
This may change in a later release.</p>
<p><em>Default Security Group</em></p>
<p>You can also use the two pre-defined security groups in Cloudbreak.</p>
<p><code>only-ssh-and-ssl:</code> all ports are locked down except for SSH and gateway HTTPS (you can't access Hadoop services outside of the VPC):</p>
<ul>
<li>SSH (22)</li>
<li>HTTPS (443)</li>
</ul>
<p><code>all-services-port:</code> all Hadoop services and SSH, gateway and HTTPS are accessible by default:</p>
<ul>
<li>SSH (22)</li>
<li>HTTPS (443)</li>
<li>Ambari (8080)</li>
<li>Consul (8500)</li>
<li>NN (50070)</li>
<li>RM Web (8088)</li>
<li>Scheduler (8030RM)</li>
<li>IPC (8050RM)</li>
<li>Job history server (19888)</li>
<li>HBase master (60000)</li>
<li>HBase master web (60010)</li>
<li>HBase RS (16020)</li>
<li>HBase RS info (60030)</li>
<li>Falcon (15000)</li>
<li>Storm (8744)</li>
<li>Hive metastore (9083)</li>
<li>Hive server (10000)</li>
<li>Hive server HTTP (10001)</li>
<li>Accumulo master (9999)</li>
<li>Accumulo Tserver (9997)</li>
<li>Atlas (21000)</li>
<li>KNOX (8443)</li>
<li>Oozie (11000)</li>
<li>Spark HS (18080)</li>
<li>NM Web (8042)</li>
<li>Zeppelin WebSocket (9996)</li>
<li>Zeppelin UI (9995)</li>
<li>Kibana (3080)</li>
<li>Elasticsearch (9200)</li>
</ul>
<p><em>Custom Security Group</em></p>
<p>You can define your own security group by adding all the ports, protocols and CIDR range you'd like to use. The rules
 defined here doesn't need to contain the internal rules, those are automatically added by Cloudbreak to the security group on AWS.</p>
<blockquote>
<p><strong>IMPORTANT</strong> 443 and 22 ports needs to be there in every security group otherwise Cloudbreak won't be able to communicate with the 
provisioned cluster</p>
</blockquote>
<p>If <code>Public in account</code> is checked all the users belonging to your account will be able to use this security group 
template to create clusters, but cannot delete it.</p>
<blockquote>
<p><strong>NOTE</strong> The security groups are created on AWS only after the cluster provisioning starts with the selected security group template.</p>
</blockquote>
<p><img alt="" src="../images/ui-secgroup_v3.png" />
<sub><em>Full size <a href="../images/ui-secgroup_v3.png">here</a>.</em></sub></p>
<h2 id="defining-cluster-services">Defining cluster services</h2>
<p><strong>Blueprints</strong></p>
<p>Blueprints are your declarative definition of a Hadoop cluster. These are the same blueprints that are <a href="https://cwiki.apache.org/confluence/display/AMBARI/Blueprints">used by Ambari</a>.</p>
<p>You can use the 3 default blueprints pre-defined in Cloudbreak or you can create your own ones.
Blueprints can be added from file, URL (an <a href="https://raw.githubusercontent
.com/sequenceiq/cloudbreak/master/integration-test/src/main/resources/blueprint/multi-node-hdfs-yarn.bp">example blueprint</a>) or the 
whole JSON can be written in the <code>JSON text</code> box.</p>
<p>The host groups in the JSON will be mapped to a set of instances when starting the cluster. Besides this the services and
 components will also be installed on the corresponding nodes. Blueprints can be modified later from the Ambari UI.</p>
<blockquote>
<p><strong>NOTE</strong> Not necessary to define all the configuration in the blueprint. If a configuration is missing, Ambari will 
fill that with a default value.</p>
</blockquote>
<p>If <code>Public in account</code> is checked all the users belonging to your account will be able to use this blueprint to 
create clusters, but cannot delete or modify it.</p>
<p><img alt="" src="../images/ui-blueprints_v3.png" />
<sub><em>Full size <a href="../images/ui-blueprints_v3.png">here</a>.</em></sub></p>
<p><strong>A blueprint can be exported from a running Ambari cluster that can be reused in Cloudbreak with slight 
modifications.</strong>
There is no automatic way to modify an exported blueprint and make it instantly usable in Cloudbreak, the 
modifications have to be done manually.
When the blueprint is exported some configurations are hardcoded for example domain names, memory configurations...etc. that won't be applicable to the Cloudbreak cluster</p>
<p><strong>Cluster customization</strong></p>
<p>Sometimes it can be useful to <strong>define some custom scripts so called Recipes in Cloudbreak</strong> that run during cluster 
creation and add some additional functionality.</p>
<p>For example it can be a service you'd like to install but it's not supported by Ambari or some script that 
automatically downloads some data to the necessary nodes.
The most <strong>notable example is Ranger setup</strong>:</p>
<ul>
<li>It has a prerequisite of a running database when Ranger Admin is installing.</li>
<li>A PostgreSQL database can be easily started and configured with a recipe before the blueprint installation starts.</li>
</ul>
<p>To learn more about these and check the Ranger recipe out, take a look at the <a href="../recipes/">Cluster customization</a></p>
<h2 id="cluster-deployment">Cluster deployment</h2>
<p>After all the cluster resources are configured you can deploy a new HDP cluster.</p>
<p>Here is a <strong>basic flow for cluster creation on Cloudbreak Web UI</strong>:</p>
<ul>
<li>Start by selecting a previously created AWS credential in the header.</li>
</ul>
<p><img alt="" src="../images/ui-credentials_v2.png" />
<sub><em>Full size <a href="../images/ui-credentials_v2.png">here</a>.</em></sub></p>
<ul>
<li>Open <code>create cluster</code></li>
</ul>
<p><code>Configure Cluster</code> tab</p>
<ul>
<li>Fill out the new cluster <code>name</code><ul>
<li>Cluster name must start with a lowercase alphabetic character then you can apply lowercase alphanumeric and 
   hyphens only (min 5, max 40 characters)</li>
</ul>
</li>
<li>Select a <code>Region</code> where you like your cluster be provisioned</li>
<li>Click on the <code>Setup Network and Security</code> button<blockquote>
<p>If <code>Public in account</code> is checked all the users belonging to your account will be able to see the created cluster on
 the UI, but cannot delete or modify it.</p>
</blockquote>
</li>
</ul>
<p><code>Setup Network and Security</code> tab</p>
<ul>
<li>Select one of the networks</li>
<li>Select one of the security groups</li>
<li>Click on the <code>Choose Blueprint</code> button<blockquote>
<p>If <code>Enable security</code> is checked as well, Cloudbreak will install Key Distribution Center (KDC) and the cluster will 
be Kerberized. See more about it in the <a href="../kerberos/">Kerberos</a> section of this documentation.</p>
</blockquote>
</li>
</ul>
<p><code>Choose Blueprint</code> tab</p>
<ul>
<li>Select one of the blueprint</li>
<li>After you've selected a <code>Blueprint</code>, you should be able to configure:<ul>
<li>the templates</li>
<li>the number of nodes for all of the host groups in the blueprint</li>
<li>the recipes for nodes</li>
</ul>
</li>
<li>Click on the <code>Review and Launch</code> button</li>
</ul>
<p><code>Review and Launch</code> tab</p>
<ul>
<li>After the <code>create and start cluster</code> button has clicked Cloudbreak will start to create the cluster's resources on 
 your AWS account.</li>
</ul>
<p>Cloudbreak uses <em>CloudFormation</em> to create the resources - you can check out the resources created by Cloudbreak on 
the AWS Console CloudFormation page.
<img alt="" src="../aws/images/aws-cloudformation_v2.png" />
<sub><em>Full size <a href="../aws/images/aws-cloudformation_v2.png">here</a>.</em></sub></p>
<p>Besides these you can check the progress on the Cloudbreak Web UI itself if you open the new cluster's <code>Event History</code>.
<img alt="" src="../images/ui-eventhistory_v3.png" />
<sub><em>Full size <a href="../images/ui-eventhistory_v3.png">here</a>.</em></sub></p>
<p><strong>Advanced options</strong></p>
<p>There are some advanced features when deploying a new cluster, these are the following:</p>
<p><code>Availability Zone</code> You can restrict the instances to a <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html">specific availability zone</a>. It may be useful if you're using
 reserved instances.</p>
<p><code>Use dedicated instances</code> You can use <a href="https://aws.amazon.com/ec2/purchasing-options/dedicated-instances/">dedicated instances</a> on EC2</p>
<p><code>Minimum cluster size</code> The provisioning strategy in case of the cloud provider cannot allocate all the requested nodes.</p>
<p><code>Validate blueprint</code> This is selected by default. Cloudbreak validates the Ambari blueprint in this case.</p>
<p><code>Shipyard enabled cluster</code> This is selected by default. Cloudbreak will start a <a href="https://shipyard-project.com/">Shipyard</a> container which helps you to manage your containers.</p>
<p><code>Config recommendation strategy</code> Strategy for configuration recommendations how will be applied. Recommended 
configurations gathered by the response of the stack advisor. </p>
<ul>
<li><code>NEVER_APPLY</code>               Configuration recommendations are ignored with this option.</li>
<li><code>ONLY_STACK_DEFAULTS_APPLY</code> Applies only on the default configurations for all included services.</li>
<li><code>ALWAYS_APPLY</code>              Applies on all configuration properties.</li>
</ul>
<p><code>Start LDAP and configure SSSD</code> Enables the <a href="../sssd/">System Security Services Daemon</a> configuration</p>
<h2 id="cluster-termination">Cluster termination</h2>
<p>You can terminate running or stopped clusters with the <code>terminate</code> button in the cluster details.</p>
<blockquote>
<p><strong>IMPORTANT</strong> Always use Cloudbreak to terminate the cluster. If that fails for some reason, try to delete the 
CloudFormation stack first. Instances are started in an Auto Scaling Group so they may be restarted if you terminate an instance manually!</p>
</blockquote>
<p>Sometimes Cloudbreak cannot synchronize it's state with the cluster state at the cloud provider and the cluster can't
 be terminated. In this case the <code>Forced termination</code> option can help to terminate the cluster at the Cloudbreak 
 side. <strong>If it has happened:</strong></p>
<ol>
<li>You should check the related resources at the AWS CloudFormation</li>
<li>If it is needed you need to manually remove resources from there</li>
</ol>
<p><img alt="" src="../images/ui-forceterminate_v2.png" />
<sub><em>Full size <a href="../images/ui-forceterminate_v2.png">here</a>.</em></sub></p>
<h1 id="interactive-mode-cloudbreak-shell">Interactive mode / Cloudbreak Shell</h1>
<p>The goal with the Cloudbreak Shell (Cloudbreak CLI) was to provide an interactive command line tool which supports:</p>
<ul>
<li>all functionality available through the REST API or Cloudbreak Web UI</li>
<li>makes possible complete automation of management task via scripts</li>
<li>context aware command availability</li>
<li>tab completion</li>
<li>required/optional parameter support</li>
<li>hint command to guide you on the usual path</li>
</ul>
<h2 id="start-cloudbreak-shell">Start Cloudbreak Shell</h2>
<p>To start the Cloudbreak CLI use the following commands:</p>
<ul>
<li>Open your <code>cloudbreak-deployment</code> directory if it is needed. For example:</li>
</ul>
<pre><code>   cd cloudbreak-deployment
</code></pre>

<ul>
<li>Start the <code>cbd</code> from here if it is needed</li>
</ul>
<pre><code>   cbd start
</code></pre>

<ul>
<li>In the root of your <code>cloudbreak-deployment</code> folder apply:</li>
</ul>
<pre><code>   cbd util cloudbreak-shell
</code></pre>

<blockquote>
<p>At the very first time it will take for a while, because of need to download all the necessary docker images.</p>
</blockquote>
<p>This will launch the Cloudbreak shell inside a Docker container then it is ready to use.
<img alt="" src="../shell/image/shell-started_v2.png" />
<sub><em>Full size <a href="../shell/image/shell-started_v2.png">here</a>.</em></sub></p>
<blockquote>
<p><strong>IMPORTANT You have to copy all your files into the <code>cbd</code> working directory, what you would like to use in shell.</strong> For 
example if your <code>cbd</code> working directory is <code>~/cloudbreak-deployment</code> then copy your <strong>blueprint JSON, public ssh key 
file...etc.</strong> to here. You can refer to these files with their names from the shell.</p>
</blockquote>
<h2 id="autocomplete-and-hints">Autocomplete and hints</h2>
<p>Cloudbreak Shell helps to you with <strong>hint messages</strong> from the very beginning, for example:</p>
<pre><code>cloudbreak-shell&gt;hint
Hint: Add a blueprint with the 'blueprint add' command or select an existing one with 'blueprint select'
cloudbreak-shell&gt;
</code></pre>

<p>Beyond this you can use the <strong>autocompletion (double-TAB)</strong> as well:</p>
<pre><code>cloudbreak-shell&gt;credential create --
credential create --AWS          credential create --AZURE        credential create --EC2          credential create --GCP          credential create --OPENSTACK
</code></pre>

<h1 id="provisioning-via-cli">Provisioning via CLI</h1>
<h2 id="setting-up-aws-credential">Setting up AWS credential</h2>
<p>Cloudbreak works by connecting your AWS account through so called Credentials, and then uses these credentials to 
create resources on your behalf. Credentials can be configured with the following command for example:</p>
<pre><code>credential create --AWS --name my-aws-credential --description &quot;sample description&quot; --roleArn 
arn:aws:iam::***********:role/userrole --sshKeyString &quot;ssh-rsa AAAAB****etc&quot;
</code></pre>

<blockquote>
<p><strong>NOTE</strong> that Cloudbreak <strong>does not set your cloud user details</strong> - we work around the concept of <a href="http://aws.amazon.com/iam/">IAM</a> - <strong>on Amazon (or other cloud providers)</strong>. You should have already a valid IAM role. You can 
find further details <a href="./#provisioning-prerequisites">here</a>.</p>
</blockquote>
<p>Alternatives to provide <code>SSH Key</code>:</p>
<ul>
<li>you can upload your public key from an url: <code>—sshKeyUrl</code> </li>
<li>or you can add the path of your public key: <code>—sshKeyPath</code></li>
</ul>
<p>You can check whether the credential was created successfully</p>
<pre><code>credential list
</code></pre>

<p>You can switch between your existing credentials</p>
<pre><code>credential select --name my-aws-credential
</code></pre>

<h2 id="infrastructure-templates_1">Infrastructure templates</h2>
<p>After your AWS account is linked to Cloudbreak you can start creating resource templates that describe your clusters' infrastructure:</p>
<ul>
<li>security groups</li>
<li>networks</li>
<li>templates</li>
</ul>
<p>When you create one of the above resource, <strong>Cloudbreak does not make any requests to AWS. Resources are only created
 on AWS after the <code>cluster create</code> has applied.</strong> These templates are saved to Cloudbreak's database and can be 
 reused with multiple clusters to describe the infrastructure.</p>
<p><strong>Templates</strong></p>
<p>Templates describe the <strong>instances of your cluster</strong> - the instance type and the attached volumes. A typical setup is
 to combine multiple templates in a cluster for the different types of nodes. For example you may want to attach multiple
 large disks to the datanodes or have memory optimized instances for Spark nodes.</p>
<p>A template can be used repeatedly to create identical copies of the same stack (or to use as a foundation to start a 
new stack). Templates can be configured with the following command for example:</p>
<pre><code>template create --AWS --name my-aws-template --description &quot;sample description&quot; --instanceType m4.large --volumeSize 
100 --volumeCount 2
</code></pre>

<p>Other available option here is <code>--publicInAccount</code>. If it is true, all the users belonging to your account will be able
 to use this template to create clusters, but cannot delete it.</p>
<p>You can check whether the template was created successfully</p>
<pre><code>template list
</code></pre>

<p><strong>Networks</strong></p>
<p>Your clusters can be created in their own <strong>Virtual Private Cloud (VPC)</strong> or in one of your already existing VPCs. If 
you choose an existing VPC it is possible to create a new subnet within the VPC or use an already existing one. The 
subnet's IP range must be defined in the <code>Subnet (CIDR)</code> field using the general CIDR notation.</p>
<p><em>Default AWS Network</em></p>
<p>If you don't want to create or use your custom VPC, you can use the <code>default-aws-network</code> for all your Cloudbreak 
clusters. It will create a new VPC with a <code>10.0.0.0/16</code> subnet every time a cluster is created.</p>
<p><em>Custom AWS Network</em></p>
<p>If you'd like to deploy a cluster to a custom VPC you'll have to <strong>create a new network</strong> template, to create a new 
subnet within the VPC, provide the ID of the subnet which is in the existing VPC.</p>
<p>A network also can be used repeatedly to create identical copies of the same stack (or to use as a foundation to 
start a new stack).</p>
<blockquote>
<p><strong>IMPORTANT</strong> The subnet CIDR cannot overlap each other in a VPC. So you have to create different network templates 
for every each clusters.
For example you can create 3 different clusters with 3 different network templates for multiple subnets 10.0.0.0/24,
 10.0.1.0/24, 10.0.2.0/24 with the same VPC and IGW identifiers.</p>
</blockquote>
<pre><code>network create --AWS --name my-aws-network --subnet 10.0.0.0/16
</code></pre>

<p>Other available options:</p>
<p><code>--vpcID</code> your existing vpc on amazon</p>
<p><code>--internetGatewayID</code> your amazon internet gateway of the given VPC</p>
<p><code>--publicInAccount</code> If it is true, all the users belonging to your account will be able to use this network to create 
clusters, but cannot delete it.</p>
<p>You can check whether the network was created successfully</p>
<pre><code>network list
</code></pre>

<h2 id="defining-cluster-services_1">Defining cluster services</h2>
<p><strong>Blueprints</strong></p>
<p>Blueprints are your declarative definition of a Hadoop cluster. These are the same blueprints that are <a href="https://cwiki.apache.org/confluence/display/AMBARI/Blueprints">used by Ambari</a>.</p>
<p>You can use the 3 default blueprints pre-defined in Cloudbreak or you can create your own ones.
Blueprints can be added from file or URL (an <a href="https://raw.githubusercontent.com/sequenceiq/cloudbreak/master/integration-test/src/main/resources/blueprint/multi-node-hdfs-yarn.bp">example blueprint</a>).</p>
<p>The host groups in the JSON will be mapped to a set of instances when starting the cluster. Besides this the services and
 components will also be installed on the corresponding nodes. Blueprints can be modified later from the Ambari UI.</p>
<blockquote>
<p><strong>NOTE</strong> Not necessary to define all the configuration in the blueprint. If a configuration is missing, Ambari will fill that with a default value.</p>
</blockquote>
<pre><code>blueprint add --name my-blueprint --description &quot;sample description&quot; --file &lt;the path of the blueprint&gt;
</code></pre>

<p>Other available options:</p>
<p><code>--url</code> the url of the blueprint</p>
<p><code>--publicInAccount</code> If it is true, all the users belonging to your account will be able to use this blueprint to create 
clusters, but cannot delete it.</p>
<p>You can check whether the blueprint was created successfully</p>
<pre><code>blueprint list
</code></pre>

<p><strong>A blueprint can be exported from a running Ambari cluster that can be reused in Cloudbreak with slight 
modifications.</strong>
There is no automatic way to modify an exported blueprint and make it instantly usable in Cloudbreak, the 
modifications have to be done manually.
When the blueprint is exported some configurations are hardcoded for example domain names, memory configurations..etc. that won't be applicable to the Cloudbreak cluster.</p>
<p><strong>Cluster customization</strong></p>
<p>Sometimes it can be useful to <strong>define some custom scripts so called Recipes in Cloudbreak</strong> that run during cluster 
creation and add some additional functionality.</p>
<p>For example it can be a service you'd like to install but it's not supported by Ambari or some script that 
automatically downloads some data to the necessary nodes.
The most <strong>notable example is Ranger setup</strong>:</p>
<ul>
<li>It has a prerequisite of a running database when Ranger Admin is installing.</li>
<li>A PostgreSQL database can be easily started and configured with a recipe before the blueprint installation starts.</li>
</ul>
<p>To learn more about these and check the Ranger recipe out, take a look at the <a href="../recipes/">Cluster customization</a></p>
<h2 id="metadata-show">Metadata show</h2>
<p>You can check the stack metadata with</p>
<pre><code>stack metadata --name myawsstack --instancegroup master
</code></pre>

<p>Other available options:</p>
<p><code>--id</code> In this case you can select a stack with id.</p>
<p><code>--outputType</code> In this case you can modify the outputformat of the command (RAW or JSON). </p>
<h2 id="cluster-deployment_1">Cluster deployment</h2>
<p>After all the cluster resources are configured you can deploy a new HDP cluster. The following sub-sections show 
you a <strong>basic flow for cluster creation with Cloudbreak Shell</strong>.</p>
<p><strong>Select credential</strong></p>
<p>Select one of your previously created AWS credential:</p>
<pre><code>credential select --name my-aws-credential
</code></pre>

<p><strong>Select blueprint</strong></p>
<p>Select one of your previously created blueprint which fits your needs:</p>
<pre><code>blueprint select --name multi-node-hdfs-yarn
</code></pre>

<p><strong>Configure instance groups</strong></p>
<p>You must configure instance groups before provisioning. An instance group define a group of nodes with a specified 
template. Usually we create instance groups for host groups in the blueprint.</p>
<pre><code>instancegroup configure --instanceGroup cbgateway --nodecount 1 --templateName minviable-aws
instancegroup configure --instanceGroup master --nodecount 1 --templateName minviable-aws
instancegroup configure --instanceGroup slave_1 --nodecount 1 --templateName minviable-aws
</code></pre>

<p>Other available option:</p>
<p><code>--templateId</code> Id of the template</p>
<p><strong>Select network</strong></p>
<p>Select one of your previously created network which fits your needs or a default one:</p>
<pre><code>network select --name default-aws-network
</code></pre>

<p><strong>Select security group</strong></p>
<p>Select one of your previously created security which fits your needs or a default one:</p>
<pre><code>securitygroup select --name all-services-port
</code></pre>

<p><strong>Create stack / Create cloud infrastructure</strong></p>
<p>Stack means the running cloud infrastructure that is created based on the instance groups configured earlier 
(<code>credential</code>, <code>instancegroups</code>, <code>network</code>, <code>securitygroup</code>). Same as in case of the API or UI the new cluster will 
use your templates and by using CloudFormation will launch your cloud stack. Use the following command to create a 
stack to be used with your Hadoop cluster:</p>
<pre><code>stack create --name myawsstack --region us-east-1
</code></pre>

<p>The infrastructure is created asynchronously, the state of the stack can be checked with the stack <code>show command</code>. If 
it reports AVAILABLE, it means that the virtual machines and the corresponding infrastructure is running at the cloud provider.</p>
<p>Other available option is:</p>
<p><code>--wait</code> - in this case the create command will return only after the process has finished. </p>
<p><strong>Create a Hadoop cluster / Cloud provisioning</strong></p>
<p><strong>You are almost done! One more command and your Hadoop cluster is starting!</strong> Cloud provisioning is done once the 
cluster is up and running. The new cluster will use your selected blueprint and install your custom Hadoop cluster 
with the selected components and services.</p>
<pre><code>cluster create --description &quot;my first cluster&quot;
</code></pre>

<p>Other available option is <code>--wait</code> - in this case the create command will return only after the process has finished. </p>
<p><strong>You are done!</strong> You have several opportunities to check the progress during the infrastructure creation then 
provisioning:</p>
<ul>
<li>Cloudbreak uses <em>CloudFormation</em> to create the resources - you can check out the resources created by Cloudbreak on
 the AWS Console CloudFormation page.</li>
</ul>
<p>For example:
<img alt="" src="../aws/images/aws-cloudformation_v2.png" />
<sub><em>Full size <a href="../aws/images/aws-cloudformation_v2.png">here</a>.</em></sub></p>
<ul>
<li>If stack then cluster creation have successfully done, you can check the Ambari Web UI. However you need to know the 
Ambari IP (for example: <code>http://52.8.110.95:8080</code>): <ul>
<li>You can get the IP from the CLI as a result (<code>ambariServerIp 52.8.110.95</code>) of the following command:</li>
</ul>
</li>
</ul>
<pre><code>         cluster show
</code></pre>

<p>For example:
<img alt="" src="../images/ambari-dashboard.png" />
<sub><em>Full size <a href="../images/ambari-dashboard.png">here</a>.</em></sub></p>
<ul>
<li>Besides these you can check the entire progress and the Ambari IP as well on the Cloudbreak Web UI itself. Open the 
new cluster's <code>details</code> and its <code>Event History</code> here.</li>
</ul>
<p>For example:
<img alt="" src="../images/ui-eventhistory_v3.png" />
<sub><em>Full size <a href="../images/ui-eventhistory_v3.png">here</a>.</em></sub></p>
<p><strong>Stop cluster</strong></p>
<p>You have the ability to <strong>stop your existing stack then its cluster</strong> if you want to suspend the work on it.</p>
<p>Select a stack for example with its name:</p>
<pre><code>stack select --name my-stack
</code></pre>

<p>Other available option to define a stack is its <code>--id</code>.</p>
<p>Every time you should stop the <code>cluster</code> first then the <code>stack</code>. So apply following commands to stop the previously 
selected stack:</p>
<pre><code>cluster stop
stack stop
</code></pre>

<p><strong>Restart cluster</strong></p>
<p><strong>Select your stack that you would like to restart</strong> after this you can apply:</p>
<pre><code>stack start
</code></pre>

<p>After the stack has successfully restarted, you can <strong>restart the related cluster as well</strong>:</p>
<pre><code>cluster start
</code></pre>

<p><strong>Upscale cluster</strong></p>
<p>If you need more instances to your infrastructure, you can <strong>upscale your selected stack</strong>:</p>
<pre><code>stack node --ADD --instanceGroup host_group_slave_1 --adjustment 6
</code></pre>

<p>Other available option is <code>--withClusterUpScale</code> - this indicates also a cluster upscale after the stack upscale. You
 can upscale the related cluster separately if you want to do this:</p>
<pre><code>cluster node --ADD --hostgroup host_group_slave_1 --adjustment 6
</code></pre>

<p><strong>Downscale cluster</strong></p>
<p>You also can reduce the number of instances in your infrastructure. <strong>After you selected your stack</strong>:</p>
<pre><code>cluster node --REMOVE  --hostgroup host_group_slave_1 --adjustment -2
</code></pre>

<p>Other available option is <code>--withStackDownScale</code> - this indicates also a stack downscale after the cluster downscale.
 You can downscale the related stack separately if you want to do this:</p>
<pre><code>stack node --REMOVE  --instanceGroup host_group_slave_1 --adjustment -2
</code></pre>

<h2 id="cluster-termination_1">Cluster termination</h2>
<p>You can terminate running or stopped clusters with</p>
<pre><code>stack terminate --name myawsstack
</code></pre>

<p>Other available option is <code>--wait</code> - in this case the terminate command will return only after the process has finished. </p>
<blockquote>
<p><strong>IMPORTANT</strong> Always use Cloudbreak to terminate the cluster. If that fails for some reason, try to delete the 
CloudFormation stack first. Instances are started in an Auto Scaling Group so they may be restarted if you terminate an instance manually!</p>
</blockquote>
<p>Sometimes Cloudbreak cannot synchronize it's state with the cluster state at the cloud provider and the cluster can't
 be terminated. In this case the <code>Forced termination</code> option on the Cloudbreak Web UI can help to terminate the cluster
  at the Cloudbreak side. <strong>If it has happened:</strong></p>
<ol>
<li>You should check the related resources at the AWS CloudFormation</li>
<li>If it is needed you need to manually remove resources from ther</li>
</ol>
<h2 id="silent-mode">Silent mode</h2>
<p>With Cloudbreak Shell you can execute script files as well. A script file contains shell commands and can 
be executed with the <code>script</code> cloudbreak shell command</p>
<pre><code>script &lt;your script file&gt;
</code></pre>

<p>or with the <code>cbd util cloudbreak-shell-quiet</code> command</p>
<pre><code>cbd util cloudbreak-shell-quiet &lt; example.sh
</code></pre>

<blockquote>
<p><strong>IMPORTANT</strong> You have to copy all your files into the <code>cbd</code> working directory, what you would like to use in shell.
 For example if your <code>cbd</code> working directory is ~/cloudbreak-deployment then copy your script file to here.</p>
</blockquote>
<h3 id="example">Example</h3>
<p>The following example creates a Hadoop cluster with <code>hdp-small-default</code> blueprint on M4Xlarge instances with 2X100G 
attached disks on <code>default-aws-network</code> network using <code>all-services-port</code> security group. You should copy your ssh 
public key file into your <code>cbd</code> working directory with name <code>id_rsa.pub</code> and paste your AWS credentials in the parts with <code>&lt;...&gt;</code> highlight.</p>
<pre><code>credential create --AWS --description description --name my-aws-credential --roleArn &lt;arn role&gt; --sshKeyPath id_rsa.pub
credential select --name my-aws-credential
template create --AWS --name awstemplate --description aws-template --instanceType m4.xlarge --volumeSize 100 
--volumeCount 2
blueprint select --name hdp-small-default
instancegroup configure --instanceGroup cbgateway --nodecount 1 --templateName awstemplate
instancegroup configure --instanceGroup host_group_master_1 --nodecount 1 --templateName awstemplate
instancegroup configure --instanceGroup host_group_master_2 --nodecount 1 --templateName awstemplate
instancegroup configure --instanceGroup host_group_master_3 --nodecount 1 --templateName awstemplate
instancegroup configure --instanceGroup host_group_client_1  --nodecount 1 --templateName awstemplate
instancegroup configure --instanceGroup host_group_slave_1 --nodecount 3 --templateName awstemplate
network select --name default-aws-network
securitygroup select --name all-services-port
stack create --name my-first-stack --region us-east-1
cluster create --description &quot;My first cluster&quot;
</code></pre>

<p><strong>Congratulations!</strong> Your cluster should now be up and running on this way as well. To learn more about Cloudbreak and 
provisioning, we have some <a href="../operations/">interesting insights</a> for you</p>
                    <a href="https://github.com/sequenceiq/cloudbreak-docs/blob/master/docs/aws.md" ><i class="fa fa-github"></i> Edit on GitHub </a>
                </div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
            <center>Documentation built with <a href="https://gliderlabs.com/pagebuilder">Pagebuilder</a>.</center>
        </footer>

        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
        <script>var base_url = '..';</script>
        <script data-main="../mkdocs/js/search.js" src="../mkdocs/js/require.js"></script>
        <script src="../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>

         <script>
           $( document ).ready(function() {
               $.getJSON("http://sequenceiq.com/cloudbreak-docs/versions.json", function(data) {
               $("#versions-dropdown").append('<li><a href="http://sequenceiq.com/cloudbreak-docs/latest">latest ('+data.latest+')</a></li>');
                $.each(data.versions, function( index, value ) {
                  $("#versions-dropdown").append('<li><a href="http://sequenceiq.com/cloudbreak-docs/'+value+'">'+value+'</a></li>');
                });
               });

               <!--AWS Table-->
               $.getJSON("../providers/aws.json", function(data) {
               $("#cloudbreak-deployer-aws-image-details").append('<br>');
               $("#cloudbreak-deployer-aws-image-details").append('<br>');
               $("#cloudbreak-deployer-aws-image-details").append('<table>');
                 $("#cloudbreak-deployer-aws-image-details").append('<col width="290">');
                 $("#cloudbreak-deployer-aws-image-details").append('<col width="290">');
                 $("#cloudbreak-deployer-aws-image-details").append('<thead>');
                  $("#cloudbreak-deployer-aws-image-details").append('<tr>');
                   $("#cloudbreak-deployer-aws-image-details").append('<th halign="center" style="font-size: 14pt;border:none;border-bottom:solid #DDDDDD 1.5pt;padding:6.0pt 6.0pt 6.0pt 6.0pt">' + "Region" + '</th>');
                   $("#cloudbreak-deployer-aws-image-details").append('<th halign="center" style="font-size: 14pt;border:none;border-bottom:solid #DDDDDD 1.5pt;padding:6.0pt 6.0pt 6.0pt 6.0pt">' + "Image Name" + '</th>');
                  $("#cloudbreak-deployer-aws-image-details").append('</tr>');
                 $("#cloudbreak-deployer-aws-image-details").append('</thead>');
                $("#cloudbreak-deployer-aws-image-details").append('<tbody>');
                 $.each(data.metadata, function( index, value ) {
                 if (index.indexOf("region.") === 0) {
                   shortIndex = index.substring(7)
                  $("#cloudbreak-deployer-aws-image-details").append('<tr>');
                   $("#cloudbreak-deployer-aws-image-details").append('<td halign="center" valign="center" text-align="left" style="font-size: 12pt;border:none;border-bottom:solid #DDDDDD 1.5pt;padding:6.0pt 6.0pt 6.0pt 6.0pt">' + shortIndex + '</td>');
                   $("#cloudbreak-deployer-aws-image-details").append('<td halign="center" valign="center" text-align="right" style="font-size: 12pt;border:none;border-bottom:solid #DDDDDD 1.5pt;padding:6.0pt 6.0pt 6.0pt 6.0pt">' + value + '</td>');
                  $("#cloudbreak-deployer-aws-image-details").append('</tr>');
                  }
                 });
                $("#cloudbreak-deployer-aws-image-details").append('</tbody>');
               $("#cloudbreak-deployer-aws-image-details").append('</table>');
               });

               <!--OpenStack CBD-->
               $.getJSON("../providers/openstack.json", function(data) {
               $("#cloudbreak-deployer-image").append('<br>');
               $("#cloudbreak-deployer-image").append('<br>');
               $("#cloudbreak-deployer-image").append('<p style="font-size: 14px;font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;line-height: 1.428571429;color: #555;">Download the latest Cloudbreak Deployer image to your local machine:</p>');
               $("#cloudbreak-deployer-image").append('<pre><code style="font-size: 12pt;color:#333333">curl -O -k https://public-repo-1.hortonworks.com/HDP/cloudbreak/' + data.id + '</code></pre>');
               $("#cloudbreak-deployer-import").append('<br>');
               $("#cloudbreak-deployer-import").append('<br>');
               $("#cloudbreak-deployer-import").append('<p style="font-size: 14px;font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;line-height: 1.428571429;color: #555;">Set the following environment variables for the OpenStack image import:</p>');
               $("#cloudbreak-deployer-import").append('<pre><code style="font-size: 12px;color:#333333">export CBD_LATEST_IMAGE=</code>' + data.id + '</code></p>');
               });

               <!--OpenStack CB-->
               $.getJSON("../providers/openstack_cloudbreak.json", function(data) {
               $("#cloudbreak-image").append('<br>');
               $("#cloudbreak-image").append('<br>');
               $("#cloudbreak-image").append('<p style="font-size: 14px;font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;line-height: 1.428571429;color: #555;">Download the latest Cloudbreak image to your local machine:</p>');
               $("#cloudbreak-image").append('<pre><code style="font-size: 12pt;color:#333333">curl -O -k https://public-repo-1.hortonworks.com/HDP/cloudbreak/' + data.id + '</code></pre>');
               $("#cloudbreak-import").append('<br>');
               $("#cloudbreak-import").append('<br>');
               $("#cloudbreak-import").append('<p style="font-size: 14px;font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;line-height: 1.428571429;color: #555;">This is very similar to the Cloudbrek Deployer. Set the following environment variables for the OpenStack image import:</p>');
               $("#cloudbreak-import").append('<pre><code style="font-size: 12px;color:#333333">export CB_LATEST_IMAGE=</code>' + data.id + '</code></p>');
               });

               <!--GCP-->
               $.getJSON("../providers/gcp.json", function(data) {
               $("#cloudbreak-deployer-gcp-image-details").append('<br>');
               $("#cloudbreak-deployer-gcp-image-details").append('<br>');
               $("#cloudbreak-deployer-gcp-image-details").append('<pre><code style="font-size: 12pt;color:#333333"> [HACK] gcloud compute images create '
                   + data.id + ' --source-uri gs://sequenceiqimage/' + data.id + '.tar.gz' + '</code></pre>');
               });
           });
         </script>
    </body>
</html>
