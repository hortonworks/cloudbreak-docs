<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="http://sequenceiq.com/cloudbreak-docs/azure/">
        <link rel="shortcut icon" href="../img/favicon.ico">

	<title>Azure - Cloudbreak 1.3.0</title>

        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation" background="red">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <img class="navbar-logo" src="../img/HWX-RGB-full-no-tagline_500pxh.png" alt="Hortonworks Documentation"
                 width="132" height="52">
            <a class="navbar-brand" href="..">Cloudbreak 1.3.0</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Home <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="..">Introduction</a>
</li>

                        
                            
<li >
    <a href="../architecture/">Architecture</a>
</li>

                        
                            
<li >
    <a href="../onprem/">Installation</a>
</li>

                        
                            
<li >
    <a href="../releasenotes/">Release Notes</a>
</li>

                        
                            
<li >
    <a href="../changelog/">Change Log</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li >
                        <a href="../aws/">AWS</a>
                    </li>
                
                
                
                    <li class="active">
                        <a href="./">Azure</a>
                    </li>
                
                
                
                    <li >
                        <a href="../gcp/">GCP</a>
                    </li>
                
                
                
                    <li >
                        <a href="../openstack/">OpenStack</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Reference <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../api/">API</a>
</li>

                        
                            
<li >
    <a href="../shell/">CLI/Shell</a>
</li>

                        
                            
<li >
    <a href="../ui_account/">Account Management</a>
</li>

                        
                            
<li >
    <a href="../periscope/">Auto-Scaling</a>
</li>

                        
                            
<li >
    <a href="../blueprints/">Blueprints</a>
</li>

                        
                            
<li >
    <a href="../topologies/">Platforms (TP)</a>
</li>

                        
                            
<li >
    <a href="../kerberos/">Kerberos (TP)</a>
</li>

                        
                            
<li >
    <a href="../mesos/">Mesos (TP)</a>
</li>

                        
                            
<li >
    <a href="../spi/">SPI</a>
</li>

                        
                            
<li >
    <a href="../operations/">Operations</a>
</li>

                        
                            
<li >
    <a href="../database/">Migration</a>
</li>

                        
                            
<li >
    <a href="../configuration/">Advanced Configuration</a>
</li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Development</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../environments/">Environments</a>
</li>

        
            
<li >
    <a href="../flow/">Flows</a>
</li>

        
    </ul>
  </li>

                        
                            
<li >
    <a href="../issues/">Known issues</a>
</li>

                        
                        </ul>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Versions <b class="caret"></b></a>
                    <ul class="dropdown-menu" id="versions-dropdown">
                    </ul>
                </li>
                
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li >
                        <a rel="next" href="../aws/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../gcp/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
                    <li>
                        <a href="https://github.com/sequenceiq/cloudbreak-docs/blob/master/docs/" >
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#azure-setup">Azure Setup</a></li>
        
            <li><a href="#deploy-using-the-azure-portal">Deploy using the Azure Portal</a></li>
        
            <li><a href="#under-the-hood">Under the hood</a></li>
        
            <li><a href="#validate-the-started-cloudbreak-deployer">Validate the started Cloudbreak Deployer</a></li>
        
    
        <li class="main "><a href="#provisioning-prerequisites">Provisioning Prerequisites</a></li>
        
            <li><a href="#azure-access-setup">Azure access setup</a></li>
        
            <li><a href="#azure-application-setup-with-cloudbreak-deployer">Azure application setup with Cloudbreak Deployer</a></li>
        
            <li><a href="#file-system-configuration">File system configuration</a></li>
        
            <li><a href="#generate-a-new-ssh-key">Generate a new SSH key</a></li>
        
    
        <li class="main "><a href="#provisioning-via-browser">Provisioning via Browser</a></li>
        
            <li><a href="#setting-up-azure-credentials">Setting up Azure credentials</a></li>
        
            <li><a href="#infrastructure-templates">Infrastructure templates</a></li>
        
            <li><a href="#defining-cluster-services">Defining cluster services</a></li>
        
            <li><a href="#cluster-deployment">Cluster deployment</a></li>
        
            <li><a href="#cluster-termination">Cluster termination</a></li>
        
    
        <li class="main "><a href="#interactive-mode-cloudbreak-shell">Interactive mode / Cloudbreak Shell</a></li>
        
            <li><a href="#start-cloudbreak-shell">Start Cloudbreak Shell</a></li>
        
            <li><a href="#autocomplete-and-hints">Autocomplete and hints</a></li>
        
    
        <li class="main "><a href="#provisioning-via-cli">Provisioning via CLI</a></li>
        
            <li><a href="#setting-up-azure-credential">Setting up Azure credential</a></li>
        
            <li><a href="#infrastructure-templates_1">Infrastructure templates</a></li>
        
            <li><a href="#defining-cluster-services_1">Defining cluster services</a></li>
        
            <li><a href="#metadata-show">Metadata show</a></li>
        
            <li><a href="#cluster-deployment_1">Cluster deployment</a></li>
        
            <li><a href="#cluster-termination_1">Cluster termination</a></li>
        
            <li><a href="#silent-mode">Silent mode</a></li>
        
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">
                    

<h1 id="azure-setup">Azure Setup</h1>
<p>On other cloud providers, we provide “public images” that are pre-built with the Cloudbreak Deployer. But on Azure, its a different process.
We provide a way to launch Cloudbreak Deployer based on the new <a href="https://github.com/Azure/azure-quickstart-templates">Azure Resource Manager
Templates</a>.</p>
<h2 id="deploy-using-the-azure-portal">Deploy using the Azure Portal</h2>
<p>To get started using the Azure Resource Manager template to install Cloudbreak, it is as simple as clicking here: <a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fsequenceiq%2Fazure-cbd-quickstart%2F1.3.0%2Fazuredeploy.json">  <img alt="deploy on azure" src="http://azuredeploy.net/deploybutton.png" /> </a></p>
<blockquote>
<p><strong><a href="../onprem/#minimum-and-recommended-system-requirements">Minimum and Recommended VM requirements</a>:</strong> 8GB RAM, 10GB disk, 2 cores (The minimum instance type which is fit for cloudbreak is <strong>D2</strong>)</p>
</blockquote>
<p><strong>The following parameters are mandatory (beyond to the default values) for the new <code>cbd</code> Template!</strong></p>
<p>On the <code>Custom deployment</code> panel:</p>
<ul>
<li>Please create a new <code>Resource group</code></li>
<li>Select an appropriate <code>Resource group location</code></li>
</ul>
<p>On the <code>Parameters</code> panel:</p>
<ul>
<li>Select the same <code>LOCATION</code> as for the resource group</li>
<li><code>PASSWORD</code> must be between 6-72 characters long and must satisfy
  at least 3 of password complexity requirements from the following:<ul>
<li>Contains an uppercase character</li>
<li>Contains a lowercase character</li>
<li>Contains a numeric digit</li>
<li>Contains a special character</li>
</ul>
</li>
</ul>
<p><strong>Finally</strong> you should review the <code>Legal terms</code> from the <code>Custom deployment</code> panel:</p>
<ul>
<li>If you agree with the terms and conditions, just click on <code>Create</code>
button of this panel</li>
<li>Also click on the <code>Create</code> button on the <code>Custom deployment</code></li>
</ul>
<blockquote>
<p>Deployment takes about <strong>15-20 minutes</strong>. You can track the
progress on the resource group details. If any issue has occurred, open the <code>Audit logs</code> from the settings.
We have faced an interesting behaviour on the Azure Portal: <a href="https://github.com/Azure/azure-quickstart-templates/issues/1294">All operations were successful on template deployment,
but overall fail</a>.</p>
</blockquote>
<ul>
<li>Once it's successful done, you can reach the Cloudbreak UI
at:<code>http://&lt;VM Public IP&gt;:3000/</code><ul>
<li>email: admin@example.com</li>
<li>password: cloudbreak</li>
</ul>
</li>
</ul>
<h2 id="under-the-hood">Under the hood</h2>
<p>Meanwhile Azure is creating the deployment, here is some information about what happens in the background:</p>
<ul>
<li>Start an instance from the official CentOS image</li>
<li>So no custom image copy is needed, which would take about 30
   minutes</li>
<li>Use <a href="https://github.com/Azure/azure-docker-extension">Docker VM Extension</a> to install Docker</li>
<li>Use <a href="https://github.com/Azure/azure-linux-extensions/tree/master/CustomScript">CustomScript Extension</a> to install
Cloudbreak Deployer (<code>cbd</code>)</li>
</ul>
<p><strong>Cloudbreak Deployer Highlights</strong></p>
<ul>
<li>The default SSH username for the Azure VMs is <code>cloudbreak</code>.</li>
<li>Cloudbreak Deployer location is <code>/var/lib/cloudbreak-deployment</code> on the launched <code>cbd</code> VM. This is the
      <code>cbd</code> root folder there.</li>
<li>All <code>cbd</code> actions must be executed from the <code>cbd</code> root folder.</li>
<li>Most of the <code>cbd</code> commands require <code>root</code> permissions. So it would be worth if you apply the <code>sudo su</code>.</li>
</ul>
<h2 id="validate-the-started-cloudbreak-deployer">Validate the started Cloudbreak Deployer</h2>
<ul>
<li>
<p>SSH to the launched Azure VM.</p>
</li>
<li>
<p>Most of the <code>cbd</code> commands require <code>root</code> permissions. So it would be worth if you apply the:</p>
</li>
</ul>
<pre><code>  sudo su
</code></pre>

<blockquote>
<p>This is a MUST on Azure because the <a href="https://github.com/Azure/azure-linux-extensions/tree/master/CustomScript">Customscript Extension</a> which basically creates everything running as sudo and this is not modifiable.</p>
</blockquote>
<ul>
<li>Open the <code>cloudbreak-deployment</code> directory:</li>
</ul>
<pre><code>  cd /var/lib/cloudbreak-deployment
</code></pre>

<ul>
<li>Pre-installed Cloudbreak Deployer version and health:</li>
</ul>
<pre><code>  cbd doctor
</code></pre>

<blockquote>
<p>In case of <code>cbd update</code> is needed, please check the related documentation for <a href="../operations/#update-cloudbreak-deployer">Cloudbreak Deployer Update</a>. Most of the <code>cbd</code> commands require <code>root</code> permissions.</p>
</blockquote>
<ul>
<li>Started Cloudbreak Application logs:</li>
</ul>
<pre><code>   cbd logs cloudbreak
</code></pre>

<blockquote>
<p>Cloudbreak should start within a minute - you should see a line like this: <code>Started CloudbreakApplication in 36.823 seconds</code></p>
</blockquote>
<h1 id="provisioning-prerequisites">Provisioning Prerequisites</h1>
<p>We use the new <a href="https://azure.microsoft.com/en-us/documentation/articles/resource-group-overview/">Azure ARM</a> in 
order to launch clusters. In order to work we need to create an <strong>Active Directory</strong> application with the configured name and password and adds the permissions that are needed to call the Azure Resource Manager API. Cloudbreak Deployer automates all this for you.</p>
<blockquote>
<p>If you forget to configure these steps you will not able to create any resource with Cloudbreak</p>
</blockquote>
<h2 id="azure-access-setup">Azure access setup</h2>
<p>If you do not have an <strong>Active Directory (AD)</strong> user then you have to configure it before deploying a cluster with 
Cloudbreak:</p>
<blockquote>
<p>Why you need this? Read more <a href="https://azure.microsoft.com/en-us/services/active-directory/">here</a></p>
</blockquote>
<ul>
<li>Go to <code>manage.windowsazure.com</code> &gt; <code>Active Directory</code></li>
<li>Select one of your AD where you would like to create the new user</li>
<li>You can configure your AD users on <code>Your active directory</code> &gt; <code>Users</code> menu</li>
</ul>
<p><img alt="" src="../azure/images/azure-aduser_v2.png" />
<sub><em>Full size <a href="../azure/images/azure-aduser_v2.png">here</a>.</em></sub></p>
<ul>
<li>Here you can add the new user to AD. Simply click on <code>Add User</code> in the bottom of the page<ul>
<li><code>TYPE OF USER</code>: select <code>New user in your organization</code></li>
<li><code>USER NAME</code>: type the new user name into the box</li>
<li>Fill out the name fields for the new user on the second page of the ADD USER window</li>
<li>Submit the new user creation on the third window with the big green button</li>
<li>Copy the password <code>Folo4965</code></li>
<li>Click on the tick button in the bottom of the the ADD USER window</li>
</ul>
</li>
<li>You will see the new user in the <code>USERS</code> list</li>
</ul>
<blockquote>
<p>You have got a temporary password so you have to change it before you start using the new user.</p>
</blockquote>
<ul>
<li>You need to add your AD user to the <code>manage.windowsazure.com</code> &gt; <code>Settings</code> &gt; <code>Administrators</code></li>
</ul>
<p><img alt="" src="../azure/images/azure-administrators_v3.png" />
<sub><em>Full size <a href="../azure/images/azure-administrators_v3.png">here</a>.</em></sub></p>
<ul>
<li>Here you can add the new user to Administrators. Simply click on <code>Add</code> in the bottom of the page<ul>
<li><code>EMAIL ADDRESS</code>: copy the previously created user email address here</li>
<li>Select the appropriate <code>SUBSCRIPTION</code> for the user</li>
<li>Click on the tick button in the bottom of the the ADD A CO-ADMINISTRATOR window</li>
</ul>
</li>
<li>You will see the new co-administrator a in the <code>ADMINISTRATORS</code> list</li>
</ul>
<h2 id="azure-application-setup-with-cloudbreak-deployer">Azure application setup with Cloudbreak Deployer</h2>
<p>In order for Cloudbreak to be able to launch clusters on Azure on your behalf you need to set up your <strong>Azure ARM 
application</strong>. If you do not want to create your ARM application via the Azure Web UI, <strong>we automated the related Azure 
configurations in the Cloudbreak Deployer</strong>.</p>
<p>If you use our <a href="./#deploy-using-the-azure-portal">Azure Template for Cloudbreak Deployer</a>, you should:</p>
<ul>
<li>SSH to the Cloudbreak Deployer Virtual machine</li>
<li><code>cbd</code> location is <code>/var/lib/cloudbreak-deployment</code></li>
<li>all <code>cbd</code> actions must be executed from the <code>cbd</code> folder</li>
</ul>
<blockquote>
<p>Most of the <code>cbd</code> commands require <code>root</code> permissions. <strong>So <code>sudo su</code> here would be worth for you.</strong></p>
</blockquote>
<p>You can setup your Azure Application with the following <code>cbd</code> command:</p>
<blockquote>
<p>Why you need this? Read more <a href="https://azure.microsoft.com/en-us/documentation/articles/role-based-access-control-configure/">here</a></p>
</blockquote>
<pre><code>cbd azure configure-arm --app_name myapp --app_password password123 --subscription_id 1234-abcd-efgh-1234
</code></pre>

<p>Other available options:</p>
<p><code>--app_name</code> your new application name, <em>app</em> by default</p>
<p><code>--app_password</code> your application password, <em>password</em> by default</p>
<p><code>--subscription_id</code> your Azure subscription ID</p>
<p><code>--username</code> your Azure username</p>
<p><code>--password</code> your Azure password</p>
<p>The command applies the following steps:</p>
<ol>
<li>It creates an Active Directory application with the configured name, password</li>
<li>It grants permissions to call the Azure Resource Manager API</li>
</ol>
<p><strong>Please use the output of the command when you creating your Azure credential in Cloudbreak.</strong> The major part of 
the output should be like this example:</p>
<pre><code>Subscription ID: sdf324-26b3-sdf234-ad10-234dfsdfsd
App ID: 234sdf-c469-sdf234-9062-dsf324
Password: password123
App Owner Tenant ID: sdwerwe1-d98e-dsf12-dsf123-df123232
</code></pre>

<h2 id="file-system-configuration">File system configuration</h2>
<p>When starting a cluster with Cloudbreak on Azure, the default file system is “Windows Azure Blob Storage”. Hadoop has 
built-in support for the <a href="https://hadoop.apache.org/docs/current/hadoop-azure/index.html">WASB file system</a> so it can be
used easily as HDFS.</p>
<h3 id="disks-and-blob-storage">Disks and blob storage</h3>
<p>In Azure every data disk attached to a virtual machine <a href="https://azure.microsoft.com/en-us/documentation/articles/virtual-machines-disks-vhds/">is stored</a> as a virtual hard disk (VHD) in a page blob inside an Azure storage account. Because these are not local disks and the operations must be done on the VHD files it causes degraded performance when used as HDFS.
When WASB is used as a Hadoop file system the files are full-value blobs in a storage account. It means better performance compared to the data disks and the WASB file system can be configured very easily but Azure storage accounts have their own <a href="https://azure.microsoft.com/en-us/documentation/articles/azure-subscription-service-limits/#storage-limits">limitations</a> as well. There is a space limitation for TB per storage account (500 TB) as well but the real bottleneck is the total request rate that is only 20000 IOPS where Azure will start to throw errors when trying to do an I/O operation.
To bypass those limits Microsoft created a small service called <a href="https://github.com/MicrosoftDX/Dash">DASH</a>. DASH itself is a service that imitates the API of the Azure Blob Storage API and it can be deployed as a Microsoft Azure Cloud Service. Because its API is the same as the standard blob storage API it can be used <em>almost</em> in the same way as the default WASB file system from a Hadoop deployment.
DASH works by sharding the storage access across multiple storage accounts. It can be configured to distribute storage account load to at most 15 <strong>scaleout</strong> storage accounts. It needs one more <strong>namespace</strong> storage account where it keeps track of where the data is stored.
When configuring a WASB file system with Hadoop, the only required config entries are the ones where the access details are described. To access a storage account Azure generates an access key that is displayed on the Azure portal or can be queried through the API while the account name is the name of the storage account itself. A DASH service has a similar account name and key, those can be configured in the configuration file while deploying the cloud service.</p>
<p><img alt="" src="../diagrams/dash.png" /></p>
<h3 id="deploying-a-dash-service-with-cloudbreak-deployer">Deploying a DASH service with Cloudbreak Deployer</h3>
<p>We automated the deployment of DASH service in Cloudbreak Deployer. After <code>cbd</code> is installed, simply run the 
following command to deploy a DASH cloud service with 5 scale out storage accounts:</p>
<pre><code>cbd azure deploy-dash --accounts 5 --prefix dash --location &quot;West Europe&quot; --instances 3
</code></pre>

<p>The command applies the following steps:</p>
<ol>
<li>It creates the namespace account and the scale out storage accounts</li>
<li>It builds the <em>.cscfg</em> configuration file based on the created storage account names and keys</li>
<li>It generates an Account Name and an Account Key for the DASH service</li>
<li>Finally it deploys the cloud service package file to a new cloud service</li>
</ol>
<p>The WASB file system configured with DASH can be used as a data lake - when multiple clusters are deployed with the 
same DASH file system configuration the same data can be accessed from all the clusters, but every cluster can have a 
different service configured as well. In that case deploy as many DASH services with <code>cbd</code> as clusters with 
Cloudbreak and configure them accordingly.</p>
<h3 id="containers-within-the-storage-account">Containers within the storage account</h3>
<p>Cloudbreak creates a new container in the configured storage account for each cluster with the following name 
pattern <code>cloudbreak-UNIQUE_ID</code>. Re-using existing containers in the same account is not supported as dirty data can 
lead to failing cluster installations. In order to take advantage of the WASB file system your data does not have to 
be in the same storage account nor in the same container. You can add as many accounts as you wish through Ambari, by
 setting the properties described <a href="https://hadoop.apache.org/docs/stable/hadoop-azure/index.html">here</a>. Once you 
 added the appropriate properties you can use those storage accounts with the pre-existing data, like:</p>
<pre><code>hadoop fs -ls wasb://data@youraccount.blob.core.windows.net/terasort-input/
</code></pre>

<blockquote>
<p><strong>IMPORTANT</strong> Make sure that your cloud account can launch instances using the new Azure ARM (a.k.a. V2) API and 
you have sufficient qouta (CPU, network, etc) for the requested cluster size.</p>
</blockquote>
<h2 id="generate-a-new-ssh-key">Generate a new SSH key</h2>
<p>All the instances created by Cloudbreak are configured to allow key-based SSH,
so you'll need to provide an SSH public key that can be used later to SSH onto the instances in the clusters you'll create with Cloudbreak.
You can use one of your existing keys or you can generate a new one.</p>
<p>To generate a new SSH keypair:</p>
<pre><code>ssh-keygen -t rsa -b 4096 -C &quot;your_email@example.com&quot;
# Creates a new ssh key, using the provided email as a label
# Generating public/private rsa key pair.
</code></pre>

<pre><code># Enter file in which to save the key (/Users/you/.ssh/id_rsa): [Press enter]
You'll be asked to enter a passphrase, but you can leave it empty.

# Enter passphrase (empty for no passphrase): [Type a passphrase]
# Enter same passphrase again: [Type passphrase again]
</code></pre>

<p>After you enter a passphrase the keypair is generated. The output should look something like below.</p>
<pre><code># Your identification has been saved in /Users/you/.ssh/id_rsa.
# Your public key has been saved in /Users/you/.ssh/id_rsa.pub.
# The key fingerprint is:
# 01:0f:f4:3b:ca:85:sd:17:sd:7d:sd:68:9d:sd:a2:sd your_email@example.com
</code></pre>

<p>Later you'll need to pass the <code>.pub</code> file's contents to Cloudbreak and use the private part to SSH to the instances</p>
<h1 id="provisioning-via-browser">Provisioning via Browser</h1>
<p>You can log into the Cloudbreak application at <code>http://&lt;Public_IP&gt;:3000/</code>.</p>
<p>The main goal of the Cloudbreak UI is to easily create clusters on your own cloud provider account.
This description details the AZURE setup - if you'd like to use a different cloud provider check out its manual.</p>
<p>This document explains the four steps that need to be followed to create Cloudbreak clusters from the UI:</p>
<ul>
<li>connect your AZURE account with Cloudbreak</li>
<li>create some template resources on the UI that describe the infrastructure of your clusters</li>
<li>create a blueprint that describes the HDP services in your clusters</li>
<li>launch the cluster itself based on these template resource</li>
</ul>
<h2 id="setting-up-azure-credentials">Setting up Azure credentials</h2>
<p>Cloudbreak works by connecting your AZURE account through so called <em>Credentials</em>, and then uses these credentials to 
create resources on your behalf. The credentials can be configured on the <strong>manage credentials</strong> panel on the 
Cloudbreak Dashboard.</p>
<blockquote>
<p>Please read the <a href="./#azure-application-setup-with-cloudbreak-deployer">Provisioning prerequisites</a> where you 
can find the steps how can get the mandatory <code>Subscription ID</code>, <code>App ID</code>, <code>Password</code> and <code>App Owner Tenant ID</code> for 
your Cloudbreak credential.</p>
</blockquote>
<p>To create a new AZURE credential follow these steps:</p>
<ul>
<li>Fill out the new credential <code>Name</code><ul>
<li>Only alphanumeric and lowercase characters (min 5, max 100 characters) can be applied</li>
</ul>
</li>
<li>Copy your AZURE Subscription ID to the <code>Subscription Id</code> field</li>
</ul>
<p><img alt="" src="../azure/images/azure-subscription.png" />
<sub><em>Full size <a href="../azure/images/azure-subscription.png">here</a>.</em></sub></p>
<ul>
<li>Copy your AZURE Active Directory Application:<ul>
<li>ID to the <code>App Id</code> field</li>
<li>password to the <code>Password</code> field</li>
<li><code>App Owner Tenant Id</code> field</li>
</ul>
</li>
</ul>
<p><img alt="" src="../azure/images/azure-application.png" />
<sub><em>Full size <a href="../azure/images/azure-application.png">here</a>.</em></sub></p>
<ul>
<li>Copy your SSH public key to the <code>SSH public key</code> field<ul>
<li>The SSH public key must be in OpenSSH format and it's private keypair can be used later to <a href="../operations/#ssh-to-the-hosts">SSH onto every 
instance</a> of every cluster you'll create with this credential.</li>
<li>The <strong>SSH username</strong> for the AZURE instances is <strong>cloudbreak</strong>.</li>
</ul>
</li>
</ul>
<blockquote>
<p>Any other parameter is optional here.</p>
<p><code>Public in account</code> means that all the users belonging to your account will be able to use this credential to create 
clusters, but cannot delete it.</p>
<p>Cloudbreak is supporting simple rsa public key instead of X509 certificate file after 1.0.4 version</p>
</blockquote>
<p><img alt="" src="../azure/images/azure-credentials.png" />
<sub><em>Full size <a href="../azure/images/azure-credentials.png">here</a>.</em></sub></p>
<h2 id="infrastructure-templates">Infrastructure templates</h2>
<p>After your AZURE account is linked to Cloudbreak you can start creating resource templates that describe your clusters' 
infrastructure:</p>
<ul>
<li>templates</li>
<li>networks</li>
<li>security groups</li>
</ul>
<p>When you create one of the above resource, <strong>Cloudbreak does not make any requests to AZURE. Resources are only created
 on AZURE after the <code>create cluster</code> button has pushed.</strong> These templates are saved to Cloudbreak's database and can be 
 reused with multiple clusters to describe the infrastructure</p>
<p><strong>Templates</strong></p>
<p>Templates describe the <strong>instances of your cluster</strong> - the instance type and the attached volumes. A typical setup is
 to combine multiple templates in a cluster for the different types of nodes. For example you may want to attach multiple
 large disks to the datanodes or have memory optimized instances for Spark nodes.</p>
<p>The instance templates can be configured on the <strong>manage templates</strong> panel on the Cloudbreak Dashboard.</p>
<p>The <code>Volume Type</code> describes the <code>Storage Account type</code> which will be used for the attached disks. The only constraint is that the <code>Premium storage</code> can only be used
for <code>DS</code> instance types. For more details about the premium storage read <a href="https://azure.microsoft.com/en-us/documentation/articles/storage-premium-storage-preview-portal/">this</a>.</p>
<p>If <code>Public in account</code>is checked all the users belonging to your account will be able to use this resource to create 
clusters, but cannot delete it</p>
<p><strong>Networks</strong></p>
<p>Your clusters can be created in their own <strong>networks</strong> or in one of your already existing one. The subnet's IP range must be defined in 
the <code>Subnet (CIDR)</code> field using the general CIDR notation.</p>
<p><em>Default AZURE Network</em></p>
<p>If you don't want to create or use your custom network, you can use the <code>default-azure-network</code> for all your 
Cloudbreak clusters. It will create a new network with a <code>10.0.0.0/16</code> subnet every time a cluster is created.</p>
<p><em>Custom AZURE Network</em></p>
<p>If you'd like to deploy a cluster to a custom network you'll have to <strong>create a new network</strong> template on the <strong>manage 
networks</strong> panel.</p>
<p>You have the following options:</p>
<ul>
<li><strong>Create a new virtual network and a new subnet</strong>:  Every time a cluster is created with this kind of network setup a new virtual network and a new subnet with the specified IP range will be created for the instances on Azure.</li>
<li><strong>Use an existing subnet in an existing virtual network</strong>: Use this kind of network setup if you have an existing virtual network with one or more subnets on Azure and you'd like to start the instances of a cluster in one of those subnets. In this case you can define the <code>Subnet Identifier</code> and the <code>Virtual Network Identifier</code> and the <code>Resource Group Identifier</code> of your network. The <code>Resource Group Identifier</code> identifies the resource group which contains your existing virtual network. The <code>Virtual Network Identifier</code> and the <code>Subnet Identifier</code> will tell Cloudbreak which network and subnet to use to launch the new instances.</li>
</ul>
<blockquote>
<p><strong>IMPORTANT</strong> In case of existing subnet make sure you have enough room within your network space for the new instances. The 
provided subnet CIDR will be ignored, but the existing subnet's CIDR range will be used. The security group behavior will be changed in this case as well
described in the security group section below.</p>
</blockquote>
<p>If <code>Public in account</code> is checked all the users belonging to your account will be able to use this network template 
to create clusters, but cannot delete it.</p>
<blockquote>
<p><strong>NOTE</strong> The new networks are created on AZURE only after the the cluster provisioning starts with the selected 
network template.</p>
</blockquote>
<p><img alt="" src="../azure/images/azure-network_v2.png" />
<sub><em>Full size <a href="../azure/images/azure-network_v2.png">here</a>.</em></sub></p>
<p><strong>Security groups</strong></p>
<p>Security group templates are very similar to the <a href="https://azure.microsoft.com/en-us/documentation/articles/virtual-networks-nsg/">security groups on Azure</a>.
<strong>They describe the allowed inbound traffic to the instances in the cluster.</strong>
Currently only one security group template can be selected for a Cloudbreak cluster and all the instances have a 
public IP address so all the instances in the cluster will belong to the same security group.
This may change in a later release.</p>
<p><em>Default Security Group</em></p>
<p>You can also use the two pre-defined security groups in Cloudbreak.</p>
<p><code>only-ssh-and-ssl:</code> all ports are locked down except for SSH and the selected Ambari Server HTTPS (you can't access Hadoop services 
outside of the virtual network):</p>
<ul>
<li>SSH (22)</li>
<li>HTTPS (443)</li>
</ul>
<p><code>all-services-port:</code> all Hadoop services, SSH and HTTPS are accessible by default:</p>
<ul>
<li>SSH (22)</li>
<li>HTTPS (443)</li>
<li>Ambari (8080)</li>
<li>Consul (8500)</li>
<li>NN (50070)</li>
<li>RM Web (8088)</li>
<li>Scheduler (8030RM)</li>
<li>IPC (8050RM)</li>
<li>Job history server (19888)</li>
<li>HBase master (60000)</li>
<li>HBase master web (60010)</li>
<li>HBase RS (16020)</li>
<li>HBase RS info (60030)</li>
<li>Falcon (15000)</li>
<li>Storm (8744)</li>
<li>Hive metastore (9083)</li>
<li>Hive server (10000)</li>
<li>Hive server HTTP (10001)</li>
<li>Accumulo master (9999)</li>
<li>Accumulo Tserver (9997)</li>
<li>Atlas (21000)</li>
<li>KNOX (8443)</li>
<li>Oozie (11000)</li>
<li>Spark HS (18080)</li>
<li>NM Web (8042)</li>
<li>Zeppelin WebSocket (9996)</li>
<li>Zeppelin UI (9995)</li>
<li>Kibana (3080)</li>
<li>Elasticsearch (9200)</li>
</ul>
<p><em>Custom Security Group</em></p>
<p>You can define your own security group by adding all the ports, protocols and CIDR range you'd like to use. The rules
 defined here doesn't need to contain the internal rules, those are automatically added by Cloudbreak to the security
  group on Azure.</p>
<blockquote>
<p><strong>IMPORTANT</strong> 443 and 22 ports needs to be there in every security group otherwise Cloudbreak won't be able to communicate with the 
provisioned cluster</p>
</blockquote>
<p>If <code>Public in account</code> is checked all the users belonging to your account will be able to use this security group 
template to create clusters, but cannot delete it.</p>
<blockquote>
<p><strong>NOTE</strong> The security groups are created on Azure only after the cluster provisioning starts with the selected 
security group template.</p>
<p><strong>IMPORTANT</strong> If you use and existing virtual network and subnet the selected security group will only be applied to the selected Ambari Server node due to the lack of
capability to attach multiple security groups to an existing subnet. If you'd like to open ports for Hadoop you must do it on your existing security group.</p>
</blockquote>
<p><img alt="" src="../images/ui-secgroup_v3.png" />
<sub><em>Full size <a href="../images/ui-secgroup_v3.png">here</a>.</em>&lt;/sub</p>
<h2 id="defining-cluster-services">Defining cluster services</h2>
<p><strong>Blueprints</strong></p>
<p>Blueprints are your declarative definition of a Hadoop cluster. These are the same blueprints that are <a href="https://cwiki.apache.org/confluence/display/AMBARI/Blueprints">used by Ambari</a>.</p>
<p>You can use the 3 default blueprints pre-defined in Cloudbreak or you can create your own ones.
Blueprints can be added from file, URL (an <a href="https://raw.githubusercontent
.com/sequenceiq/cloudbreak/master/integration-test/src/main/resources/blueprint/multi-node-hdfs-yarn.bp">example blueprint</a>) or the 
whole JSON can be written in the <code>JSON text</code> box.</p>
<p>The host groups in the JSON will be mapped to a set of instances when starting the cluster. Besides this the services and
 components will also be installed on the corresponding nodes. Blueprints can be modified later from the Ambari UI.</p>
<blockquote>
<p><strong>NOTE</strong> Not necessary to define all the configuration in the blueprint. If a configuration is missing, Ambari will 
fill that with a default value.</p>
</blockquote>
<p>If <code>Public in account</code> is checked all the users belonging to your account will be able to use this blueprint to 
create clusters, but cannot delete or modify it.</p>
<p><img alt="" src="../images/ui-blueprints_v3.png" />
<sub><em>Full size <a href="../images/ui-blueprints_v3.png">here</a>.</em></sub></p>
<p><strong>A blueprint can be exported from a running Ambari cluster that can be reused in Cloudbreak with slight 
modifications.</strong>
There is no automatic way to modify an exported blueprint and make it instantly usable in Cloudbreak, the 
modifications have to be done manually.
When the blueprint is exported some configurations are hardcoded for example domain names, memory configurations...etc. that won't be applicable to the Cloudbreak cluster</p>
<h2 id="cluster-deployment">Cluster deployment</h2>
<p>After all the cluster resources are configured you can deploy a new HDP cluster.</p>
<p>Here is a <strong>basic flow for cluster creation on Cloudbreak Web UI</strong>:</p>
<ul>
<li>Start by selecting a previously created Azure credential in the header.</li>
<li>Open <code>create cluster</code></li>
</ul>
<p><code>Configure Cluster</code> tab</p>
<ul>
<li>Fill out the new cluster <code>name</code><ul>
<li>Cluster name must start with a lowercase alphabetic character then you can apply lowercase alphanumeric and
   hyphens only (min 5, max 40 characters)</li>
</ul>
</li>
<li>Select a <code>Region</code> where you like your cluster be provisioned</li>
<li>Click on the <code>Setup Network and Security</code> button<blockquote>
<p>If <code>Public in account</code> is checked all the users belonging to your account will be able to see the created cluster on
 the UI, but cannot delete or modify it.</p>
</blockquote>
</li>
</ul>
<p><code>Setup Network and Security</code> tab</p>
<ul>
<li>Select one of the networks</li>
<li>Select one of the security groups</li>
<li>Click on the <code>Choose Blueprint</code> button<blockquote>
<p>If <code>Enable security</code> is checked as well, Cloudbreak will install Key Distribution Center (KDC) and the cluster will
be Kerberized. See more about it in the <a href="../kerberos/">Kerberos</a> section of this documentation.</p>
</blockquote>
</li>
</ul>
<p><code>Choose Blueprint</code> tab</p>
<ul>
<li>Select one of the blueprint</li>
<li>After you've selected a <code>Blueprint</code>, you should be able to configure:<ul>
<li>the templates</li>
<li>the number of nodes for all of the host groups in the blueprint</li>
</ul>
</li>
<li>You need to select where you want to install the Ambari server to. Only 1 host group can be selected.
   If you want to install the Ambari server to a separate node, you need to extend your blueprint with a new host group
   which contains only 1 service: HDFS_CLIENT and select this host group for the Ambari server. Note: this host group cannot be scaled so
   it is not advised to select a 'slave' host group for this purpose.</li>
<li>Click on the <code>Add File System</code> button</li>
</ul>
<p><code>Add File System</code> tab</p>
<ul>
<li>Select one of the file system that fits your needs</li>
<li>After you've selected <code>WASB</code> or <code>DASH</code>, you should configure:<ul>
<li><code>Storage Account Name</code></li>
<li><code>Storage Account Access Key</code></li>
</ul>
</li>
<li>Click on the <code>Review and Launch</code> button<blockquote>
<p><code>File system</code> is a mandatory configuration for Azure. You can read more about WASB and DASH in the <a href="./#file-system-configuration">File System Configuration section</a>.</p>
</blockquote>
</li>
</ul>
<p><code>Review and Launch</code> tab</p>
<ul>
<li>After the <code>create and start cluster</code> button has clicked Cloudbreak will start to create the cluster's resources on
 your Azure account.</li>
</ul>
<p>Cloudbreak uses <em>Azure Resource Manager</em> to create the resources - you can check out the resources created by Cloudbreak
 on
the <code>Azure Portal Resource groups</code> page.
<img alt="" src="../azure/images/azure-resourcegroup.png" />
<sub><em>Full size <a href="../azure/images/azure-resourcegroup.png">here</a>.</em></sub></p>
<p>Besides these you can check the progress on the Cloudbreak Web UI itself if you open the new cluster's <code>Event History</code>.
<img alt="" src="../azure/images/azure-eventhistory.png" />
<sub><em>Full size <a href="../azure/images/azure-eventhistory.png">here</a>.</em></sub></p>
<p><strong>Advanced options</strong></p>
<p>There are some advanced features when deploying a new cluster, these are the following:</p>
<p><code>Ambari Username</code> This user will be used as admin user in Ambari. You can log in using this username on the Ambari UI.</p>
<p><code>Ambari Password</code> The password associated with the Ambari username. This password will be also the default password for all required passwords which are not specified in the blueprint. E.g: hive DB password.</p>
<p><code>Minimum cluster size</code> The provisioning strategy in case of the cloud provider cannot allocate all the requested nodes.</p>
<p><code>Validate blueprint</code> This is selected by default. Cloudbreak validates the Ambari blueprint in this case.</p>
<p><code>Shipyard enabled cluster</code> This is selected by default. Cloudbreak will start a <a href="https://shipyard-project.com/">Shipyard</a> container which helps you to manage your containers.</p>
<p><code>Persistent Storage Name</code> This is <code>cbstore</code> by default. Cloudbreak will copy the image into a storage which is not deleting under the termination. When you starting a new cluster then the provisioning will be much faster because of the existing image.</p>
<p><code>Attached Storage Type</code> This is <code>single storage for all vm</code> by default. If are you using the default option then your whole cluster will by in one storage which could be a bottleneck in case of <a href="https://azure.microsoft.com/hu-hu/documentation/articles/azure-subscription-service-limits/#storage-limits">Azure</a>. If you are using the <code>separated storage for every vm</code> then we will deploy as much storage account as many node you have and in this case IOPS limit concern just for one node.</p>
<p><code>Config recommendation strategy</code> Strategy for configuration recommendations how will be applied. Recommended
configurations gathered by the response of the stack advisor.</p>
<ul>
<li><code>NEVER_APPLY</code>               Configuration recommendations are ignored with this option.</li>
<li><code>ONLY_STACK_DEFAULTS_APPLY</code> Applies only on the default configurations for all included services.</li>
<li><code>ALWAYS_APPLY</code>              Applies on all configuration properties.</li>
</ul>
<h2 id="cluster-termination">Cluster termination</h2>
<p>You can terminate running or stopped clusters with the <code>terminate</code> button in the cluster details.</p>
<blockquote>
<p><strong>IMPORTANT</strong> Always use Cloudbreak to terminate the cluster. If that fails for some reason, try to delete the 
Azure resource group first. Instances are started in an Auto Scaling Group so they may be restarted if you terminate an 
instance manually!</p>
</blockquote>
<p>Sometimes Cloudbreak cannot synchronize it's state with the cluster state at the cloud provider and the cluster can't
 be terminated. In this case the <code>Forced termination</code> option can help to terminate the cluster at the Cloudbreak 
 side. <strong>If it has happened:</strong></p>
<ol>
<li>You should check the related resources at the Azure Portal</li>
<li>If it is needed you need to manually remove resources from there</li>
</ol>
<p><img alt="" src="../azure/images/azure-forceterminate.png" />
<sub><em>Full size <a href="../azure/images/azure-forceterminate.png">here</a>.</em></sub></p>
<h1 id="interactive-mode-cloudbreak-shell">Interactive mode / Cloudbreak Shell</h1>
<p>The goal with the Cloudbreak Shell (Cloudbreak CLI) was to provide an interactive command line tool which supports:</p>
<ul>
<li>all functionality available through the REST API or Cloudbreak Web UI</li>
<li>makes possible complete automation of management task via scripts</li>
<li>context aware command availability</li>
<li>tab completion</li>
<li>required/optional parameter support</li>
<li>hint command to guide you on the usual path</li>
</ul>
<h2 id="start-cloudbreak-shell">Start Cloudbreak Shell</h2>
<p>To start the Cloudbreak CLI use the following commands:</p>
<ul>
<li>Open your <code>cloudbreak-deployment</code> directory if it is needed. For example:</li>
</ul>
<pre><code>   cd cloudbreak-deployment
</code></pre>

<ul>
<li>Start the <code>cbd</code> from here if it is needed</li>
</ul>
<pre><code>   cbd start
</code></pre>

<ul>
<li>In the root of your <code>cloudbreak-deployment</code> folder apply:</li>
</ul>
<pre><code>   cbd util cloudbreak-shell
</code></pre>

<blockquote>
<p>At the very first time it will take for a while, because of need to download all the necessary docker images.</p>
</blockquote>
<p>This will launch the Cloudbreak shell inside a Docker container then it is ready to use.
<img alt="" src="../shell/image/shell-started_v2.png" />
<sub><em>Full size <a href="../shell/image/shell-started_v2.png">here</a>.</em></sub></p>
<blockquote>
<p><strong>IMPORTANT You have to copy all your files into the <code>cbd</code> working directory, what you would like to use in shell.</strong> For 
example if your <code>cbd</code> working directory is <code>~/cloudbreak-deployment</code> then copy your <strong>blueprint JSON, public ssh key 
file...etc.</strong> to here. You can refer to these files with their names from the shell.</p>
</blockquote>
<h2 id="autocomplete-and-hints">Autocomplete and hints</h2>
<p>Cloudbreak Shell helps to you with <strong>hint messages</strong> from the very beginning, for example:</p>
<pre><code>cloudbreak-shell&gt;hint
Hint: Add a blueprint with the 'blueprint add' command or select an existing one with 'blueprint select'
cloudbreak-shell&gt;
</code></pre>

<p>Beyond this you can use the <strong>autocompletion (double-TAB)</strong> as well:</p>
<pre><code>cloudbreak-shell&gt;credential create --
credential create --AWS          credential create --AZURE        credential create --EC2          credential create --GCP          credential create --OPENSTACK
</code></pre>

<h1 id="provisioning-via-cli">Provisioning via CLI</h1>
<h2 id="setting-up-azure-credential">Setting up Azure credential</h2>
<p>Cloudbreak works by connecting your Azure account through so called Credentials, and then uses these credentials to 
create resources on your behalf. Credentials can be configured with the following command for example:</p>
<pre><code>credential create --AZURE --name my-azure-credential --description &quot;sample credential&quot; --subscriptionId 
your-azure-subscription-id --tenantId your-azure-application-tenant-id --appId 
your-azure-application-id --password YourApplicationPassword --sshKeyString &quot;ssh-rsa AAAAB3***etc.&quot;
</code></pre>

<blockquote>
<p>Cloudbreak is supporting simple rsa public key instead of X509 certificate file after 1.0.4 version</p>
<p><strong>NOTE</strong> that Cloudbreak <strong>does not set your cloud user details</strong> - we work around the concept of Access Control 
Service (ACS). You should have already a valid Azure Subscription and Application. You can find further details <a href="./#provisioning-prerequisites">here</a>.</p>
</blockquote>
<p>Alternatives to provide <code>SSH Key</code>:</p>
<ul>
<li>you can upload your public key from an url: <code>—sshKeyUrl</code> </li>
<li>or you can add the path of your public key: <code>—sshKeyPath</code></li>
</ul>
<p>You can check whether the credential was created successfully</p>
<pre><code>credential list
</code></pre>

<p>You can switch between your existing credentials</p>
<pre><code>credential select --name my-azure-credential
</code></pre>

<h2 id="infrastructure-templates_1">Infrastructure templates</h2>
<p>After your Azure account is linked to Cloudbreak you can start creating resource templates that describe your clusters' 
infrastructure:</p>
<ul>
<li>security groups</li>
<li>networks</li>
<li>templates</li>
</ul>
<p>When you create one of the above resource, <strong>Cloudbreak does not make any requests to Azure. Resources are only created
 on Azure after the <code>cluster create</code> has applied.</strong> These templates are saved to Cloudbreak's database and can be 
 reused with multiple clusters to describe the infrastructure.</p>
<p><strong>Templates</strong></p>
<p>Templates describe the <strong>instances of your cluster</strong> - the instance type and the attached volumes. A typical setup is
 to combine multiple templates in a cluster for the different types of nodes. For example you may want to attach multiple
 large disks to the datanodes or have memory optimized instances for Spark nodes.</p>
<p>A template can be used repeatedly to create identical copies of the same stack (or to use as a foundation to start a 
new stack). Templates can be configured with the following command for example:</p>
<pre><code>template create --AZURE --name my-azure-template --description &quot;sample description&quot; --instanceType Standard_D4 --volumeSize 100 --volumeCount 2 --volumeType Standard_LRS
</code></pre>

<p>The <code>Volume Type</code> describes the <code>Storage Account type</code> which will be used for the attached disks. The only constraint is that the <code>Premium storage</code> can only be used
for <code>DS</code> instance types. For more details about the premium storage read <a href="https://azure.microsoft.com/en-us/documentation/articles/storage-premium-storage-preview-portal/">this</a>.</p>
<p>Other available option here is <code>--publicInAccount</code>. If it is true, all the users belonging to your account will be able
 to use this template to create clusters, but cannot delete it.</p>
<p>You can check whether the template was created successfully</p>
<pre><code>template list
</code></pre>

<p><strong>Networks</strong></p>
<p>Your clusters can be created in their own <strong>networks</strong> or in one of your already existing one. If you choose an 
existing network, it is possible to create a new subnet within the network. The subnet's IP range must be defined in 
the <code>Subnet (CIDR)</code> field using the general CIDR notation.</p>
<p><em>Default AZURE Network</em></p>
<p>If you don't want to create or use your custom network, you can use the <code>default-azure-network</code> for all your 
Cloudbreak clusters. It will create a new network with a <code>10.0.0.0/16</code> subnet and <code>10.0.0.0/8</code> address prefix every 
time a cluster is created.</p>
<p><em>Custom AZURE Network</em></p>
<p>If you'd like to deploy a cluster to a custom network you'll have to apply the following command:</p>
<pre><code>network create --AZURE --name my-azure-network --addressPrefix 192.168.123.123 --subnet 10.0.0.0/16
</code></pre>

<blockquote>
<p><strong>IMPORTANT</strong> Please make sure the defined subnet and theirs address prefixes here doesn't overlap with any of your 
already deployed subnet and its already used address prefix in the network, because of the validation only happens 
after the cluster creation 
starts.</p>
<p>In case of existing subnet make sure you have enough room within your network space for the new instances. The 
provided subnet CIDR will be ignored, but a proper CIDR range will be used.</p>
</blockquote>
<p>You can check whether the network was created successfully</p>
<pre><code>network list
</code></pre>

<p><code>--addressPrefix</code> This list will be appended to the current list of address prefixes.</p>
<ul>
<li>The address prefixes in this list should not overlap between them.</li>
<li>The address prefixes in this list should not overlap with existing address prefixes in the network.</li>
</ul>
<p>You can find more details about the AZURE Address Prefixes <a href="https://azure.microsoft.com/en-us/documentation/articles/azure-cli-arm-commands/#azure-network-commands-to-manage-network-resources">here</a>.</p>
<p>If <code>--publicInAccount</code> is true, all the users belonging to your account will be able to use this network template 
to create clusters, but cannot delete it.</p>
<blockquote>
<p><strong>NOTE</strong> The new networks are created on AZURE only after the the cluster provisioning starts with the selected 
network template.</p>
</blockquote>
<h2 id="defining-cluster-services_1">Defining cluster services</h2>
<p><strong>Blueprints</strong></p>
<p>Blueprints are your declarative definition of a Hadoop cluster. These are the same blueprints that are <a href="https://cwiki.apache.org/confluence/display/AMBARI/Blueprints">used by Ambari</a>.</p>
<p>You can use the 3 default blueprints pre-defined in Cloudbreak or you can create your own ones.
Blueprints can be added from file or URL (an <a href="https://raw.githubusercontent.com/sequenceiq/cloudbreak/master/integration-test/src/main/resources/blueprint/multi-node-hdfs-yarn.bp">example blueprint</a>).</p>
<p>The host groups in the JSON will be mapped to a set of instances when starting the cluster. Besides this the services and
 components will also be installed on the corresponding nodes. Blueprints can be modified later from the Ambari UI.</p>
<blockquote>
<p><strong>NOTE</strong> Not necessary to define all the configuration in the blueprint. If a configuration is missing, Ambari will fill that with a default value.</p>
</blockquote>
<pre><code>blueprint add --name my-blueprint --description &quot;sample description&quot; --file &lt;the path of the blueprint&gt;
</code></pre>

<p>Other available options:</p>
<p><code>--url</code> the url of the blueprint</p>
<p><code>--publicInAccount</code> If it is true, all the users belonging to your account will be able to use this blueprint to create 
clusters, but cannot delete it.</p>
<p>You can check whether the blueprint was created successfully</p>
<pre><code>blueprint list
</code></pre>

<p><strong>A blueprint can be exported from a running Ambari cluster that can be reused in Cloudbreak with slight 
modifications.</strong>
There is no automatic way to modify an exported blueprint and make it instantly usable in Cloudbreak, the 
modifications have to be done manually.
When the blueprint is exported some configurations are hardcoded for example domain names, memory configurations..etc. that won't be applicable to the Cloudbreak cluster.</p>
<h2 id="metadata-show">Metadata show</h2>
<p>You can check the stack metadata with</p>
<pre><code>stack metadata --name myawsstack --instancegroup master
</code></pre>

<p>Other available options:</p>
<p><code>--id</code> In this case you can select a stack with id.</p>
<p><code>--outputType</code> In this case you can modify the outputformat of the command (RAW or JSON). </p>
<h2 id="cluster-deployment_1">Cluster deployment</h2>
<p>After all the cluster resources are configured you can deploy a new HDP cluster. The following sub-sections show
you a <strong>basic flow for cluster creation with Cloudbreak Shell</strong>.</p>
<p><strong>Select credential</strong></p>
<p>Select one of your previously created Azure credential:</p>
<pre><code>credential select --name my-azure-credential
</code></pre>

<p><strong>Select blueprint</strong></p>
<p>Select one of your previously created blueprint which fits your needs:</p>
<pre><code>blueprint select --name multi-node-hdfs-yarn
</code></pre>

<p><strong>Configure instance groups</strong></p>
<p>You must configure instance groups before provisioning. An instance group define a group of nodes with a specified
template. Usually we create instance groups for host groups in the blueprint. For Ambari server only 1 host group can be specified.
If you want to install the Ambari server to a separate node, you need to extend your blueprint with a new host group
which contains only 1 service: HDFS_CLIENT and select this host group for the Ambari server. Note: this host group cannot be scaled so
it is not advised to select a 'slave' host group for this purpose.</p>
<pre><code>instancegroup configure --instanceGroup master --nodecount 1 --templateName minviable-aws --ambariServer true
instancegroup configure --instanceGroup slave_1 --nodecount 1 --templateName minviable-aws --ambariServer false
</code></pre>

<p>Other available option:</p>
<p><code>--templateId</code> Id of the template</p>
<p><strong>Select network</strong></p>
<p>Select one of your previously created network which fits your needs or a default one:</p>
<pre><code>network select --name default-azure-network
</code></pre>

<p><strong>Select security group</strong></p>
<p>Select one of your previously created security which fits your needs or a default one:</p>
<pre><code>securitygroup select --name all-services-port
</code></pre>

<p><strong>Create stack / Create cloud infrastructure</strong></p>
<p>Stack means the running cloud infrastructure that is created based on the instance groups configured earlier
(<code>credential</code>, <code>instancegroups</code>, <code>network</code>, <code>securitygroup</code>). Same as in case of the API or UI the new cluster will
use your templates and by using Azure ARM will launch your cloud stack. Use the following command to create a
stack to be used with your Hadoop cluster:</p>
<pre><code>stack create --name myazurestack --region &quot;North Europe&quot;
</code></pre>

<p>The infrastructure is created asynchronously, the state of the stack can be checked with the stack <code>show command</code>. If
it reports AVAILABLE, it means that the virtual machines and the corresponding infrastructure is running at the cloud provider.</p>
<p>Other available option is:</p>
<p><code>--wait</code> - in this case the create command will return only after the process has finished.</p>
<p><code>--persistentStorage</code> - This is <code>cbstore</code> by default. Cloudbreak will copy the image into a storage which is not deleting under the termination. When you starting a new cluster then the provisioning will be much faster because of the existing image.</p>
<p><code>--attachedStorageType</code> - This is <code>SINGLE</code> by default. If you are using the default option then your whole cluster will by in one storage which could be a bottleneck in case of <a href="https://azure.microsoft.com/hu-hu/documentation/articles/azure-subscription-service-limits/#storage-limits">Azure</a>. If you are using the <code>PER_VM</code> then we will deploy as much storage account as many node you have and in this case IOPS limit concern just for one node.</p>
<p><strong>Create a Hadoop cluster / Cloud provisioning</strong></p>
<p><strong>You are almost done! One more command and your Hadoop cluster is starting!</strong> Cloud provisioning is done once the
cluster is up and running. The new cluster will use your selected blueprint and install your custom Hadoop cluster
with the selected components and services.</p>
<pre><code>cluster create --description &quot;my first cluster&quot;
</code></pre>

<p>Other available option is <code>--wait</code> - in this case the create command will return only after the process has finished.</p>
<p><strong>You are done!</strong> You have several opportunities to check the progress during the infrastructure creation then
provisioning:</p>
<ul>
<li>Cloudbreak uses <em>ARM</em> to create the resources - you can check out the resources created by Cloudbreak on
 the Azure Portal Resource groups page.</li>
</ul>
<p><img alt="" src="../azure/images/azure-resourcegroups_2.png" />
<sub><em>Full size <a href="../azure/images/azure-resourcegroups_2.png">here</a>.</em></sub></p>
<ul>
<li>If stack then cluster creation have successfully done, you can check the Ambari Web UI. However you need to know the
Ambari IP (for example: <code>http://23.101.60.49:8080</code>):<ul>
<li>You can get the IP from the CLI as a result (<code>ambariServerIp 23.101.60.49</code>) of the following command:</li>
</ul>
</li>
</ul>
<pre><code>         cluster show
</code></pre>

<p><img alt="" src="../images/ambari-dashboard_2.png" />
<sub><em>Full size <a href="../images/ambari-dashboard_2.png">here</a>.</em></sub></p>
<ul>
<li>Besides these you can check the entire progress and the Ambari IP as well on the Cloudbreak Web UI itself. Open the
new cluster's <code>details</code> and its <code>Event History</code> here.</li>
</ul>
<p><img alt="" src="../azure/images/azure-eventhistory_2.png" />
<sub><em>Full size <a href="../azure/images/azure-eventhistory_2.png">here</a>.</em></sub></p>
<p><strong>Stop cluster</strong></p>
<p>You have the ability to <strong>stop your existing stack then its cluster</strong> if you want to suspend the work on it.</p>
<p>Select a stack for example with its name:</p>
<pre><code>stack select --name my-stack
</code></pre>

<p>Other available option to define a stack is its <code>--id</code>.</p>
<p>Every time you should stop the <code>cluster</code> first then the <code>stack</code>. So apply following commands to stop the previously 
selected stack:</p>
<pre><code>cluster stop
stack stop
</code></pre>

<p><strong>Restart cluster</strong></p>
<p><strong>Select your stack that you would like to restart</strong> after this you can apply:</p>
<pre><code>stack start
</code></pre>

<p>After the stack has successfully restarted, you can <strong>restart the related cluster as well</strong>:</p>
<pre><code>cluster start
</code></pre>

<p><strong>Upscale cluster</strong></p>
<p>If you need more instances to your infrastructure, you can <strong>upscale your selected stack</strong>:</p>
<pre><code>stack node --ADD --instanceGroup host_group_slave_1 --adjustment 6
</code></pre>

<p>Other available option is <code>--withClusterUpScale</code> - this indicates also a cluster upscale after the stack upscale. You
 can upscale the related cluster separately if you want to do this:</p>
<pre><code>cluster node --ADD --hostgroup host_group_slave_1 --adjustment 6
</code></pre>

<p><strong>Downscale cluster</strong></p>
<p>You also can reduce the number of instances in your infrastructure. <strong>After you selected your stack</strong>:</p>
<pre><code>cluster node --REMOVE  --hostgroup host_group_slave_1 --adjustment -2
</code></pre>

<p>Other available option is <code>--withStackDownScale</code> - this indicates also a stack downscale after the cluster downscale.
 You can downscale the related stack separately if you want to do this:</p>
<pre><code>stack node --REMOVE  --instanceGroup host_group_slave_1 --adjustment -2
</code></pre>

<h2 id="cluster-termination_1">Cluster termination</h2>
<p>You can terminate running or stopped clusters with</p>
<pre><code>stack terminate --name myawsstack
</code></pre>

<p>Other available option is <code>--wait</code> - in this case the terminate command will return only after the process has finished. </p>
<blockquote>
<p><strong>IMPORTANT</strong> Always use Cloudbreak to terminate the cluster. If that fails for some reason, try to delete the 
CloudFormation stack first. Instances are started in an Auto Scaling Group so they may be restarted if you terminate an instance manually!</p>
</blockquote>
<p>Sometimes Cloudbreak cannot synchronize it's state with the cluster state at the cloud provider and the cluster can't
 be terminated. In this case the <code>Forced termination</code> option on the Cloudbreak Web UI can help to terminate the cluster
  at the Cloudbreak side. <strong>If it has happened:</strong></p>
<ol>
<li>You should check the related resources at the AWS CloudFormation</li>
<li>If it is needed you need to manually remove resources from ther</li>
</ol>
<h2 id="silent-mode">Silent mode</h2>
<p>With Cloudbreak Shell you can execute script files as well. A script file contains shell commands and can 
be executed with the <code>script</code> cloudbreak shell command</p>
<pre><code>script &lt;your script file&gt;
</code></pre>

<p>or with the <code>cbd util cloudbreak-shell-quiet</code> command</p>
<pre><code>cbd util cloudbreak-shell-quiet &lt; example.sh
</code></pre>

<blockquote>
<p><strong>IMPORTANT</strong> You have to copy all your files into the <code>cbd</code> working directory, what you would like to use in shell.
 For example if your <code>cbd</code> working directory is ~/cloudbreak-deployment then copy your script file to here.</p>
</blockquote>
<h3 id="example">Example</h3>
<p>The following example creates a hadoop cluster with <code>hdp-small-default</code> blueprint on Standard_D3 instances with 
2X100G attached disks on <code>default-azure-network</code> network using <code>all-services-port</code> security group. You should copy 
your ssh public key file into your <code>cbd</code> working directory with name <code>id_rsa.pub</code> and paste your Azure credentials in 
the parts with <code>&lt;...&gt;</code> highlight.</p>
<pre><code>credential create --AZURE --description &quot;credential description&quot; --name myazurecredential --subscriptionId &lt;your Azure subscription id&gt; --appId &lt;your Azure application id&gt; --tenantId &lt;your tenant id&gt; --password &lt;your Azure application password&gt; --sshKeyPath id_rsa.pub
credential select --name myazurecredential
template create --AZURE --name azuretemplate --description azure-template --instanceType Standard_D3 --volumeSize 100 
--volumeCount 2
blueprint select --name hdp-small-default
instancegroup configure --instanceGroup host_group_master_1 --nodecount 1 --templateName azuretemplate --ambariServer true
instancegroup configure --instanceGroup host_group_master_2 --nodecount 1 --templateName azuretemplate --ambariServer false
instancegroup configure --instanceGroup host_group_master_3 --nodecount 1 --templateName azuretemplate --ambariServer false
instancegroup configure --instanceGroup host_group_client_1  --nodecount 1 --templateName azuretemplate --ambariServer false
instancegroup configure --instanceGroup host_group_slave_1 --nodecount 3 --templateName azuretemplate --ambariServer false
network select --name default-azure-network
securitygroup select --name all-services-port
stack create --AZURE --name my-first-stack --region &quot;West US&quot; --wait true
cluster create --description &quot;My first cluster&quot; --wait true
</code></pre>

<p><strong>Congratulations!</strong> Your cluster should now be up and running on this way as well. To learn more about Cloudbreak and 
provisioning, we have some <a href="../operations/">interesting insights</a> for you.</p>
                    <a href="https://github.com/sequenceiq/cloudbreak-docs/blob/master/docs/azure.md" ><i class="fa fa-github"></i> Edit on GitHub </a>
                </div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
            <center>Documentation built with <a href="https://gliderlabs.com/pagebuilder">Pagebuilder</a>.</center>
        </footer>

        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
        <script>var base_url = '..';</script>
        <script data-main="../mkdocs/js/search.js" src="../mkdocs/js/require.js"></script>
        <script src="../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>

         <script>
           $( document ).ready(function() {
               $.getJSON("http://sequenceiq.com/cloudbreak-docs/versions.json", function(data) {
               $("#versions-dropdown").append('<li><a href="http://sequenceiq.com/cloudbreak-docs/latest">latest ('+data.latest+')</a></li>');
                $.each(data.versions, function( index, value ) {
                  $("#versions-dropdown").append('<li><a href="http://sequenceiq.com/cloudbreak-docs/'+value+'">'+value+'</a></li>');
                });
               });

               <!--AWS Table-->
               $.getJSON("../providers/aws.json", function(data) {
               $("#cloudbreak-deployer-aws-image-details").append('<br>');
               $("#cloudbreak-deployer-aws-image-details").append('<br>');
               $("#cloudbreak-deployer-aws-image-details").append('<table>');
                 $("#cloudbreak-deployer-aws-image-details").append('<col width="290">');
                 $("#cloudbreak-deployer-aws-image-details").append('<col width="290">');
                 $("#cloudbreak-deployer-aws-image-details").append('<thead>');
                  $("#cloudbreak-deployer-aws-image-details").append('<tr>');
                   $("#cloudbreak-deployer-aws-image-details").append('<th halign="center" style="font-size: 14pt;border:none;border-bottom:solid #DDDDDD 1.5pt;padding:6.0pt 6.0pt 6.0pt 6.0pt">' + "Region" + '</th>');
                   $("#cloudbreak-deployer-aws-image-details").append('<th halign="center" style="font-size: 14pt;border:none;border-bottom:solid #DDDDDD 1.5pt;padding:6.0pt 6.0pt 6.0pt 6.0pt">' + "Image Name" + '</th>');
                  $("#cloudbreak-deployer-aws-image-details").append('</tr>');
                 $("#cloudbreak-deployer-aws-image-details").append('</thead>');
                $("#cloudbreak-deployer-aws-image-details").append('<tbody>');
                 $.each(data.metadata, function( index, value ) {
                 if (index.indexOf("region.") === 0) {
                   shortIndex = index.substring(7)
                  $("#cloudbreak-deployer-aws-image-details").append('<tr>');
                   $("#cloudbreak-deployer-aws-image-details").append('<td halign="center" valign="center" text-align="left" style="font-size: 12pt;border:none;border-bottom:solid #DDDDDD 1.5pt;padding:6.0pt 6.0pt 6.0pt 6.0pt">' + shortIndex + '</td>');
                   $("#cloudbreak-deployer-aws-image-details").append('<td halign="center" valign="center" text-align="right" style="font-size: 12pt;border:none;border-bottom:solid #DDDDDD 1.5pt;padding:6.0pt 6.0pt 6.0pt 6.0pt">' + value + '</td>');
                  $("#cloudbreak-deployer-aws-image-details").append('</tr>');
                  }
                 });
                $("#cloudbreak-deployer-aws-image-details").append('</tbody>');
               $("#cloudbreak-deployer-aws-image-details").append('</table>');
               });

               <!--OpenStack CBD-->
               $.getJSON("../providers/openstack.json", function(data) {
               $("#cloudbreak-deployer-image").append('<br>');
               $("#cloudbreak-deployer-image").append('<br>');
               $("#cloudbreak-deployer-image").append('<p style="font-size: 14px;font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;line-height: 1.428571429;color: #555;">Download the latest Cloudbreak Deployer image to your local machine:</p>');
               $("#cloudbreak-deployer-image").append('<pre><code style="font-size: 12pt;color:#333333">curl -O -k https://public-repo-1.hortonworks.com/HDP/cloudbreak/' + data.metadata.image_name + '.img</code></pre>');
               $("#cloudbreak-deployer-import").append('<br>');
               $("#cloudbreak-deployer-import").append('<br>');
               $("#cloudbreak-deployer-import").append('<p style="font-size: 14px;font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;line-height: 1.428571429;color: #555;">Set the following environment variables for the OpenStack image import:</p>');
               $("#cloudbreak-deployer-import").append('<pre><code style="font-size: 12px;color:#333333">export CBD_LATEST_IMAGE=</code>' + data.metadata.image_name + '.img</code></p>');
               });

               <!--OpenStack CB-->
               $.getJSON("../providers/openstack_cloudbreak.json", function(data) {
               $("#cloudbreak-image").append('<br>');
               $("#cloudbreak-image").append('<br>');
               $("#cloudbreak-image").append('<p style="font-size: 14px;font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;line-height: 1.428571429;color: #555;">Download the latest Cloudbreak image to your local machine:</p>');
               $("#cloudbreak-image").append('<pre><code style="font-size: 12pt;color:#333333">curl -O -k https://public-repo-1.hortonworks.com/HDP/cloudbreak/' + data.metadata.image_name + '.img</code></pre>');
               $("#cloudbreak-import").append('<br>');
               $("#cloudbreak-import").append('<br>');
               $("#cloudbreak-import").append('<p style="font-size: 14px;font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;line-height: 1.428571429;color: #555;">This is very similar to the Cloudbrek Deployer. Set the following environment variables for the OpenStack image import:</p>');
               $("#cloudbreak-import").append('<pre><code style="font-size: 12px;color:#333333">export CB_LATEST_IMAGE=</code>' + data.metadata.image_name + '.img</code></p>');
               });

               <!--GCP-->
               $.getJSON("../providers/gcp.json", function(data) {
               $("#cloudbreak-deployer-gcp-image-details").append('<br>');
               $("#cloudbreak-deployer-gcp-image-details").append('<br>');
               $("#cloudbreak-deployer-gcp-image-details").append('<pre><code style="font-size: 12pt;color:#333333"> gcloud compute images create '
                   + data.id + ' --source-uri gs://sequenceiqimage/' + data.id + '.tar.gz' + '</code></pre>');
               });
           });
         </script>
    </body>
</html>
